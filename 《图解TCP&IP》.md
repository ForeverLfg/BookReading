# 《图解TCP/IP》

# 一、网络基础知识

## 1.OSI模型

![image-20210711231605561](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210711231605561.png)

* 发送端和接收端的处理流程正好**相反**，就像收发快递一样。发送方执行的是打包的操作，接收方则执行拆包操作。

* 数据每向下传输一层，就加一层标签；同样的，没向上传递一层，就拆一层标签。

## 2.传输方式的分类

### 2.1 面向有连接型和面向无连接型

  ![image-20210711235046362](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210711235046362.png)

###     2.2 电路交换与分组交换

![image-20210712001203066](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210712001203066.png)

![image-20210712001441804](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210712001441804.png)

## 3. 地址

* 网络通信中，每一层协议所使用的地址不尽相同。

* MAC地址和IP地址在标识一个通信主体时虽然都具有唯一性，但是他们当中只有**IP地址**具有唯一性。

* **地址转发表**：MAC寻址所参考的表；**路由控制表**：IP寻址参考的表。

  ![image-20210712224202415](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210712224202415.png)

## 4.网络的构成要素

![image-20210712230140999](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210712230140999.png)

* 从严格意义上讲，各种传输媒介中信号的流动速度是恒定的。
* 传输速率高并不是指单位数据流动的速度有多快，而是指单位时间内传输的数据量有多少。
* 低速数据链路就如同车道较少无法让很多车同时通过；高速速率相当于有多个车道，一次允许更多车辆行驶的道路。
* 主机之间实际的额传输速率被称做吞吐量，单位为bps(每秒比特数)；吞吐量不仅衡量贷款，也衡量主机的CPU处理能力、网络的拥堵程度、报文中数据字段的占有份额。



### 4.1 中继器--物理层

![image-20210712232719067](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210712232719067.png)

* 对减弱的信号进行放大和发送
* 通过物理层的连接延长网络
* 即使在数据链路层出现某些错误，中继器仍然转发数据
* 中继器无法改变传输速率



### 4.2 网桥（2层交换机）——数据链路层

* 在OSI模型的第2层（数据链路层），连接两个网络；
* 将数据帧临时存储于内存，再重新生成信号作为一个全新的帧转发给相连的另一个网段；
* 数据帧中有一位叫FCS，用以校验数据是否正确送达目的地；
* 根据MAC地址进行处理。

![image-20210712234345237](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210712234345237.png)

![image-20210712234940360](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210712234940360.png)

* 以太网等网络中经常使用的交换集线器（Hub）,现在也属于网桥的一种；交换集线器中连接电缆的每个端口都能提供类似网桥的功能。

  

## 4.3 路由器（3层交换机）--网络层

* **网桥根据物理地址（MAC地址）进行处理**，路由器则根据IP地址进行处理;
* 路由器可以连接两个不同的网络；
* 路由器还分担网络负荷，甚至有的路由器还具备一定的网络安全功能。

### 4.4 4-7层交换机

* 处理OSI模型中从传输层到应用层的数据。
* 举例：负载均衡器（多台服务器来分担访问压力）、带宽控制（优先处理及时性要求较高的通信请求，放缓处理及时性不高的要求）、广域网加速器、特殊应用访问加速和防火墙

## 4.5 网关

![img](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fwww.elecfans.com%2Fbaike%2FUploadPic%2F2010-4%2F20104315148597.jpg&refer=http%3A%2F%2Fwww.elecfans.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1628724847&t=0ed7170b53839305cf55d13849c59803)

* **协议的转换**和**数据的转发**；

* 在两个不能进行直接通信的协议之间进行翻译，最终实现两者之间的通信；

* 手机和互联网设置了一层网关；

  **网关举例**：

  代理服务器：为了控制流量以及处于安全的考虑，这种叫做应用网关。

  防火墙：针对不同应用提高了安全性。
  
  ## 4.6 现代网络实态
  
  * 核心网：计算机网络的核心
  * 接入层（汇聚层）：计算机网络中连接“边缘网络”的部分
  * 移动通信：基站收集的通信请求被汇集到控制中心（“边缘网络”），之后会再被接入到互联通信控制中心
  * CSFB：让语音呼叫部分仅在收集通信网络中传输
  * 边缘网络：网络中相应于高速公路出入口的部分。
  * 数据中心：对于那些人气较高的作品，其访问量可能会达到每天几十万次。面对这么高的并发访问量，托管主机服务，为了减少访问延迟，会集合多个存储于一起，通过连接高速网络，以期提高响应速度。有些大型的数据中心甚至直接连接“主干网”。
  * **虚拟化技术**：当一个网站需要调整运营所使用的资源时，并不增减服务器、存储设备、网络等实际的物理设备，而是利用软件将这些物理设备虚拟化，在有必要增减资源的时候，通过软件按量增减的一种机制。可以实现按需分配、按比例分配，对外提供可靠的服务。
  * 云：根据使用者的情况动态调整必要资源的机制。
  
  ![image-20210713140515470](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210713140515470.png)

# 二、TCP/IP基础知识

* TCP和IP是互联网的众多通信协议中最为著名的。

![image-20210713214859777](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210713214859777.png)

## 1.TCP/IP的历史进程

![image-20210713221111670](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210713221111670.png)

## 2.TCP/IP的标准化

![image-20210713221658280](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210713221658280.png)

* TCP/IP协议指的是利用IP进行通信时所必须用到的协议群的统称。



## 3.TCP/IP标准化的精髓

* 开放性+实用性

* “TCP/IP”简直就是先开发程序，后写规格标准

* RFC（Request For Comment）：在互联网上公布。不仅激励了协议规范内容，还包含了协议的实现和运用的相关信息。

* RFC文档通过编号组织每个协议的标准化请求，有人提出每当对RFC进行修改时都要产生新的RFC编号太麻烦，于是人们采用STD方式管理。STD记录哪个编号指定哪个协议。

* 主机和路由器处理ICMP时所涉及的要求细节也写入了RFC，分别为RFC1122和RFC1812。

  

## 4.TCP/IP的标准化流程

* TCP/IP的标准化过程与一般的标准化过程不同。它不是由标准化组织指定为标准之后才开始投入应用，而是到其成为标准的那一刻为止，已经被较为充分地试验并得到较广的普及。

![image-20210713224526343](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210713224526343.png)



![image-20210721214328722](C:\Users\mi'ku\AppData\Roaming\Typora\typora-user-images\image-20210721214328722.png)



![分层中包的结构](E:\Github学习\BookReading\Pictures\分层中包的结构.jpg)

* 每个分层中，都会对所发送的数据附加一个首部；

* 网络中传输的数据包由两部分组成：一部分是协议所要用到的首部，另一部分是上层传过来的数据；

* 看到包首部，就如同看到协议的规范；

  

  **发送数据包**

  - 应用层：点击“发送”那一刻就可以开始TCP/IP通信了
  
  - TCP提供将应用层发来的数据顺利发送至对端
  
  - IP将TCP传过来的TCP首部和TCP数据合起来当做自己的数据，并加上自己的IP首部；IP包生成后，参考路由控制表决定接受此IP包的路由或主机
  
  - 如果尚不知接收端的MAC地址，可以利用ARP查找
  
  - 从IP传过来的IP包，对于以太网驱动来说就是数据。加上以太网首部并进行发送处理
  
  - 以太网首部中包含接收端MAC地址、发送端MAC地址
  
    
  
  
    - 包流动时，从前往后依次被附加了**以太网首部**，**IP包首部**，**TCP（UDP）包首部**以及**应用自己的包首部和数据**。而包的最后则追加了以太网包尾。
    - 每个包首部中至少都会包含两个信息：一个是发送端和接收端地址，另一个时上一层的协议类型。
    - 经过每个协议分层时，都必须由识别包发送端和接收端的信息。以太网会用MAC地址，IP会用IP地址，而TCP(UDP)会用端口号。
    - 每个分层的包首部中还包含一个识别位，用来标识上一层协议的种类信息。



**接收数据包**

* 网络接口（以太网驱动）处理：如果不是IP而是其他诸如ARP包，则将数据传给ARP处理
* IP模块处理：分发给TCP和UDP，需要借助路由控制表
* TCP模块处理：TCP会计算校验和，判断数据时候损坏，接收端会发送一个“确认回执”。如果这个回执一直没有返回给发送端，则发送端会一直反复发送。
* 应用程序的处理：邮件会被保存到本机的硬盘上。





**SNS中的通信实例**：由于移动电话、智能手机、平板电脑等在进行分组数据的通信时，在它们装入电池开机的那一刻，已经由运营商设定了具体的IP地址。**启动电话中的应用程序时，会连接制定的服务器，经过用户名、密码验证后服务器上累计的信息就会发送到手机终端上。**

# 三. 数据链路

## 3.1 数据链路相关技术



**MAC地址**（00:80:4A:12:21:01）：

* MAC地址长48比特。在使用网卡（NIC）的情况下，MAC地址一般会被烧到ROM中。
  - 第1位：单播地址（0）/ 多播地址（1）
  - 第2位：全局地址（0）/ 本地地址（1）
  - 第3~24位：由IEEE管理并保证各厂家之间不重复
  - 第25-48位：由厂商管理并保证产品之间不重复
  
* IEEE802.3制定的MAC地址规范时没有限定数据链路的类型，即不论哪种数据链路的网络（以太网、FDDI、ATM、无线LAN、蓝牙等），都不会有相同的MAC地址出现。例外：虚拟机MAC地址由软件分配

* 厂商识别码：有一种设备叫网络分析器，可以分析出局域网中的包是哪个厂商的网卡发出的。

* 共享介质型网络：多个设备共享一个通信介质，设备之间使用同一个载波信道进行发送和接收，分为**争用方式**和**令牌传递方式**。

* 争用方式：网络中的各个站采用先到先得的方式占用信道传送数据，也叫载波监听多路访问（CSMA）；

* 令牌传递方式：沿着令牌环发送一种叫做“令牌”的特殊报文，只有获得令牌的站才能传送数据。

* **非共享介质网络** 
  - 网络中的每个站直连交换机，由交换机负责转发数据。缺点是一旦交换机发生故障，与之相连的所有计算机之间都将无法通信。
  - **半双工**：只发送或只接收，若两端同时说话，是听不见对方说话的。
  - **全双工**：允许在同一时间既可以发送数据也可以接收数

  

  ### 3.2 以太网帧格式

  * 以太网前端有一个叫做前导码的部分，由0,1数字交替组合而成，表示一个以太网帧的开始，也是对端网卡能够确保与其同步的标志。
  * 以太网帧本体的前端是以太网的首部，它总共占14个字节。分别是6个字节的目标MAC地址、6个字节的源MAC地址以及2个字节的上层协议类型。
  * 紧随帧头后面的是数据。一个数据帧所能容纳的最大数据范围位46~1500个字节。
  * 帧尾是一个叫做FCS的四个字节。
  * 在目标MAC地址中存放了目标工作站得物理地址。源MAC地址中则存放了构造以太网帧的发送端工作站物理地址。
  * **类型**通常跟数据一起传送，它包含用以标识协议类型的编号，即表明以太网的再上一层网络协议的类型。
  * 帧尾最后出现的是FCS，用以检查帧是否有所损坏。

  

  ### 3.3 无线通信

  * IEEE 802委员会制定了无线PAN、无线LAN、无线MAN以及无线RAN等无线标准。无线LAN的最典型代表就是手机通信。

  ### 3.4 PPP

  * PPP是指点对点，主要包含两个协议：一个是不依赖上层的LCP协议，另一个时依赖上层的NCP协议。如果上层是IP，此时的NCP也叫作IPCP。
  * LCP主要负责建立和断开连接、设置最大接收单元、设置验证协议以及设置是否进行通信质量的监控。
  * IPCP则负责IP地址设置以及是否进行TCP/IP首部压缩等设置。
  * 通过PPP连接时，通常需要验证用户名和密码，并且对通信两端进行双向验证。其验证协议有两种：PAP和CHAP。
    * PAP是PPP连接建立时，通过两次握手进行用户名和密码验证。其中密码以明文方式传输。因此一般用于安全要求并不很高的环境，否则会有窃听或盗用连接的危险。
    * CHAP是使用一次性密码OTP，可以有效防止窃听。此外，在建立连接后还可以进行定期的密码交换，用来验证对端是否中途被替换。

  ## 四、IP协议

  ### 4.1 IP即网际协议

  * 数据链路层的主要作用是在互联同一种数据链路的节点之间进行包传递。而一旦跨越多种数据链路，就需要借助网络层。网络层可以跨越不同的数据链路，即使是在不同的数据链路上也能实现两端节点之间的数据包传输。
  * 数据链路层提供两个直连设备之间的通信功能。与之相比，作为网络层的IP则负责在没有直连的两个网络之间进行通信传输。
  * IP大致分为三大作用模块：**IP寻址**、**路由**以及**IP分包与组包**。
  * 多跳路由指的是路由器或主机在转发IP数据包时只指定下一个路由器或主机，而不是将到最终目标地址为止的所有通路全部指定出来。
  * 为了将数据包发给目标主机，所有主机都维护着一张**路由控制表**。该表记录IP数据在下一步应该发给哪个路由器。IP包将根据这个路由表在各个数据链路上传输。

  ### 4.2 IP地址的基础知识

  - IP地址的两个组成部分：**网络标识**和**主机标识**。
    * A类地址：首位以“0” 开头的地址。从第1位到第8位是网络标识；后24位相当于主机标识。
    * B类地址：前两位以“10”开头的地址。从第1位到第16位是网络标识；后16位是主机标识。
    * C类地址：前三位以“110”开头的地址。从第1位到第24位是网络标识；后8位是主机标识、
    * D类地址：前四位以“1110”开头的地址。从第1位到第32位为网络标识；没有主机标识。
  - 主机地址不可以全部为0，也不可以全部为1.**全部为0表示对应的网络地址或IP地址不可获知；全部为1表示广播地址**。
  - 广播地址分为：**本地广播**和**直接广播**。
  - IP多播：在人们使用多播功能之前，一直采用广播的方式。那时广播将数据发给所有终端主机，再由这些主机IP之上的一层去判断是否有必要接收数据。是则接收，否则丢弃，这样造成网络上很多不必要的流量。因此，**多播这种既可以穿透路由器，又可以实现只给那些必要的组发送数据包的技术就成为必选之路**。
  - IP多播使用D类地址，前四位是“1110”，剩下的28位为多播的组编号。
  - 对于多播，所有的主机必须属于224.0.0.1的组，所有的路由器必须属于224.0.0.2的组。
  - **利用IP多播实现通信，除了地址外还需要IGMP等协议的支持。**
  - 由于网络标识相同的计算机必须属于同一个链路，因此直接使用A类或B类地址确实有些浪费。随着互联网的覆盖范围逐渐增大，网络地址会越来越不够用。
  - 人们通过“子网掩码”细分出比A类、B类、C类和D类更加细分的网络。
  - 人们之后放弃IP地址的分类，采用任意长度分割IP地址的网络标识和主机标识，叫做CIDR。
  - 之后人们提出组织内要使用可变长度、高效的IP地址分配方式，随之也就产生了一种可以随机修改组织内各个部门的子网掩码长度的机制----**VLSM**。
  - 如果一直按照采用唯一IP地址的方案，会有IP地址耗尽的风险，于是出现一种新技术：不要求每一台主机或路由器分配一个固定的IP地址，而是在必要的时候只为一定数量的设备分配一个唯一IP地址。于是出现了私有网络的IP地址。而与支对应的就是公有IP地址。
  - 现在很多公司和学校都采用每个终端设置私有IP，而在路由器或必要的服务器上设置全局IP地址的方法。在不同的域里面出现相同的私有IP地址不会影响使用。**私有IP地址有它对应的范围。**
  - **由此，私有IP地址结合NAT技术已成为现在解决IP地址分配问题的主流方法**。
  - 一般只有在需要固定IP的情况下才会申请全局IP地址。现在普遍采用的方式是通过少数设置全局IP地址的代理服务器，结合NAT的设置进行互联网通信。这是IP地址个数就不限于LAN中主机个数而是由代理服务器和NAT个数决定。
  - 网络技术人员可以通过检查ICMP包、利用traceroute等明年定位发生异常的设备或线路最近的IP地址。



