《计算机网络》第七版



# 一、概述

* 三大网络：电信网络、有线电视网络和计算机网络，现在是**三网融合**。
* 网络把许多计算机连接到一起，而互联网则把许多网络通过路由器连接到一起。与网络相连的计算机常称为主机。
* 现在的互联网已不是某个组织所拥有，而是世界上大大小小的ISP所共同拥有的，这就是互联网也称为“网络的网络”的原因。
* 速率：网络技术中的速率指的是数据的传送速率，也称为数据率或比特率，速率的单位是bit/s。
* 带宽：某信道允许通过的信号频带范围。
* 互联网现在采用存储转发的**分组交换**技术，以及三层ISP结构。
* 互联网按工作方式可划分为边缘部分与核心部分。主机在网络的边缘部分，其作用是进行信息处理。路由器在网络的核心部分，其作用是按存储转发方式进行分组交换。
* 按作用范围的不同，计算机网络分为广域网WAN、城域网MAN、局域网LAN和个人区域网PAN。
* 五层协议的体系结构由应用层、运输层、网络层、数据链路层和物理层组成。运输层最重要的协议是TCP和UDP协议，而网络层最重要的协议是IP协议。



# 二、物理层

## 2.1 有关信道的几个基本概念

1. 单工通信：只能由一个方向的通信而没有反方向的交互，如无线电广播。
2. 半双工通信：通信的双方都可以发送消息，但不能双方同时发送。
3. 全双工通信：通信的双方都可以同时发送和接收消息。
4. 基带信号：来自信源的信号，基带信号往往包含较多的低频成分，甚至由直流成分，而许多信道并不能传输这种低频成分和直流分量，于是需要对基带信号进行**调制**。
5. 正交振幅调制：为了达到更高的信息传输速率，必须采用技术上更为复杂的多元制的振幅相位混合调制方法。
6. 奈式准则：在任何信道中，码元传输的速率是有上限的，传输速率超过此上限，就会出现严重的码间串扰问题，使接收端对码元的判决成为不可能。
7. 香农公式:信道的带宽或信道中的信噪比越大，信息传输的极限速率就越高。
8. 带宽：信号具有的频带宽度，允许信号通过的频率范围。

## 2.2 物理层下面的传输媒介

1. 双绞线：把两根互相绝缘的铜导线并排放在一起，然后用规则的方法绞合起来。模拟传输和数字传输都可以使用双绞线，通信距离一般为几到十几公里。使用双绞线最多的地方就是电话系统。
2. 同轴电缆：由内导体铜芯线、绝缘层和网状编织的外导体屏蔽层组成。目前同轴电缆主要用在有线电视网的居民小区中。
3. 光缆：利用光导纤维传递光脉冲来进行通信，原理是光的全反射。
4. 多模光纤：存在多条不同角度入射的光线在一条光纤中传输。光脉冲在多模光纤中传输会逐渐展宽，造成失真，因此多模光纤只适合短距离传输。
5. 单模光纤：光纤的直径减小到只有一个光的波长，则光纤就像一根波导那样，可以使光线一直向前传播，而不会产生多次反射。单模光纤的光源要使用昂贵的半导体激光器，而不能使用廉价的发光二极管。
6. 微波通信：
   * 微波波段频率很高，其频段范围也很宽，因此其通信信道的容量很大。
   * 微波接力通信相邻之间必须直视，不能由障碍物。
7. 卫星通信：
   * 通信距离远，且通信费用与通信距离无关。
   * 频带很宽，通信容量大，信号受到的干扰小。
   * 具有较大的时延。
   * 保密性相对较差。

## 2.3 信道复用技术

1. 如果在发送端使用一个复用器，就可以让大家合起来使用一个共享信道进行通信。在接收端再使用分用器，把合起来传输的信息分别送到相应的终点。

### 2.3.1 （统计）时分复用

* 所有用户在不同的时间占用同样的频带宽度。
* 当某用户暂时无数据发送时，在时分复用帧中分配给该用户的时隙只能出于空闲状态，其他用户即使一直有数据要发送，也不能使用这些空闲的时隙，造成了信道利用率不高的结果。
* **统计时分复用**是一种改进的时分复用，它能明显地提高信道的利用率。统计时分复用使用STDM帧来传送复用的数据，但每一个STDM帧中的时隙数小于连接在集中器上的用户数。各用户有了数据就随时发往集中器的输入缓存，然后**集中器**按顺序依次扫描输入缓存，把缓存中的输入数据放入STDM帧中。对没有数据的缓存就跳过去。当一个帧的数据放满了，就放出去。**因此，STDM帧不是固定分配时隙，而是按需动态地分配时隙。**这样可以提高信道的利用率。
* **集中器**能够正常工作的前提是假定各用户都是间歇地工作。
* 由于STDM帧中的时隙并不是固定地分配给某个用户，因此在每个时隙中还必须有用户的地址信息，这是统计时分复用必须要有的，且是不可避免的一些开销。

### 2.3.2 波分复用

* 光的频分复用。
* 人们经常在一根光缆中放入尽可能多的光纤，然后对每一根光纤使用密集波分复用技术。

### 2.3.3 码分复用（CDM）

* 一种共享信道的方法，更常用码分多址（CDMA）来描述。
* 每一个用户可以在同样的时间使用同样的频带进行通信。由于各用户使用经过特殊挑选的不同码型，因此各用户之间不会造成干扰。



## 2.4 带宽接入技术

### 2.4.1 ADSL技术（非对称数字用户线）

* 用数字技术对现有的模拟电话用户线进行改造，使它能够承载带宽数字业务。
* 由于用户上网时主要是从互联网下载各种文档，而向互联网发送的信息量一般都不太大，因此，ADSL的下行带宽都远远大于上行带宽。

### 2.4.2 光纤同轴混合网（HFC网）

* 在目前覆盖面很广的有线电视网的基础上开发的一种居民宽带接入网，除可传送电视节目外，还能提供电话、数据和其他带宽交互型业务。
* 为了提高传输的可靠性和电视信号的质量，HFC网把原有线电视网中的同轴电缆主干部分改换为光纤。光纤从头端连接到光纤结点。在光纤结点光信号被转换为电信号，然后通过同轴电缆传送到每个家庭。
* 要使现在的模拟电视能够接收数字电视信号，需要把一个叫做**机顶盒**的设备连接在同轴电缆和电视机之间。

### 2.4.3 FTTx技术

* FTTx表示多种带宽光纤接入方式，表示Fiber to the ....(FTTH:fiber to the home.).



# 三、数据链路层

* 数据链路层的点对点信道：PPP协议；广播信道：CSMA/CD协议。
* 数据链路层的三个基本问题：封装成帧、透明传输和差错检测。
* 适配器、转发器、集线器、网桥、以太网交换机的作用以及使用场合。
* 路由器在转发分组时使用的协议栈只有下面的三层：数据进入路由器后要先从物理层上到网络层，在转发表中找到下一跳的地址后，再下到物理层转发出去。

## 3.1 使用点对点信道的数据链路层

1. 数据链路层把网络层交下来的数据**封装成帧**发送到链路上，以及把接收到的帧中的数据取出并上交给网络层。在互联网中，网络层协议数据单元就是IP数据报。
2. 数据链路层不必考虑物理层如何实现比特传输的细节。
3. 三个基本问题：封装成帧、透明传输和差错检测。

### 3.1.1 封装成帧

* 一段数据的前后分别添加首部和尾部。首部和尾部的一个重要作用就是进行帧界定。
* **最大传输单元（MTU）**：每一种链路层协议都规定了所能传送的帧的**数据部分长度上限。**
* 假定发送端在尚未发送完一个帧时突然出现故障，中断了发送。但随后很快又恢复正常，于是重新从头开始发送刚才未发送完的帧。由于使用了帧界定符，接收端就知道前面收到的数据是个不完整的帧。

### 3.1.2 透明传输

* 传输的数据中任何8比特的组合一定不允许和用作帧界定的控制字符的比特编码一样，否则就会出现帧界定错误。
* **透明**是一个很重要的术语：表示某一个实际存在的食物看起来却好像并不存在一样。
* 透明传输设法使数据中可能出现的控制字符，在接收端不被解释为控制字符。具体做法是：发送端的数据链路层在数据中出现控制字符"SOH"和“EOT”的前面插入一个转义字符“ESC”。而在接收端的数据链路层在把数据送往网络层之前删除这个插入的转义字符。**这种方法成为字节填充或字符填充。**如果转义字符也出现在数据中，那么解决办法仍然是在转义字符的前面插入一个转义字符。**因此，当接收端收到连续的两个转义字符时，就删除其中前面的一个。**

### 3.1.3 差错检测

* **误码率**：传输错误的比特占所传输比特总数的比率。
* 误码率与信噪比有很大的关系。如果设法提高信噪比，就可以使误码率减小。实际的通信链路并非是理想的，他不可能使误码率下降到零。
* **目前在数据链路层广泛使用了循环冗余检验（CRC）的检错技术。**
* CRC运算就是在数据M的后面添加供差错检测用的n位冗余码，然后构成一个帧发送出去。**在所要发送的数据后面增加了n位冗余码，虽然增大了数据传输的开销，但却可以进行差错检测。**
* 为了进行检错而添加的冗余码常称为**帧检验序列FCS**。
* 循环冗余检验CRC和帧检验序列FCS并不是同一个概念。CRC是一种检错方法，而FCS是添加在数据后面的冗余码，在检错方法上可以选用CRC，但也可以不选用 CRC。
* **在数据链路层，发送端帧检验序列FCS的生成和接收端CRC检验都是由硬件完成的，不会延误数据传输。**
* 可靠传输：数据链路层的发送端发送什么，在接收端就收到什么。传输差错可分为两大类：一类就是最基本的比特差错，另一类传输差错则更为复杂（帧丢失、帧重复或帧失序）。
* 对于通信质量良好的有线传输链路，数据链路层协议不使用确认和重传机制，既不要求数据链路层向上提供可靠传输的服务。如果在数据链路层传输数据时出现了差错并且需要进行改正，那么改正差错的任务就由上层协议来完成。对于通信质量较差的无线传输链路，数据链路层协议使用确认和重传机制，数据链路层向上提供可靠传输的服务。**实践证明：这样做可以提高通信效率。**

## 3.2 点对点协议PPP

* 在通信线路质量较差的年代，在数据链路层使用可靠传输协议曾经是一个好办法（**高级数据链路控制（）HDLC**）。但现在HDLC已经很少使用了，现在用的更多地是点对点协议PPP。
* 互联网用户通常要连接到某个ISP才能接入到互联网。**PPP协议就是用户计算机和ISP进行通信时所使用的数据链路层协议。**
* PPP协议设计时必须考虑以下多方面的需求：
  1. **简单**：设计时，把复杂的部分放在TCP协议中，而IP则相对简单，只提供不可靠的数据报服务。在这种情况下，数据链路层没有必要提供比IP协议更多地功能。因此，对数据链路的帧，不需要纠错，不需要顺序控制，不需要流量控制。**接收方每收到一个帧，就进行CRC校验。如果CRC校验正确，就留下这个帧，反之则抛弃这个帧。**
  2. **封装成帧**：PPP协议必须规定特殊字符作为帧界定符。
  3. **透明性**：如果数据遇到和**帧界定符**一样的比特组合，就采取有效地措施来解决这个问题。
  4. **多种网络层协议**：能够在同一条物理链路上同时支持多种网络层协议。同时支持在链路所连接的局域网或路由器上运行的各种网络层协议。
  5. **多种类型链路**：除了要支持多种网络层的协议外，PPP还必须能够在多种类型的链路上运行（串行的、并行的、同步的、异步的、低速的、高速的、电的、光的、交换的、非交换的）。
  6. **差错检测**：立即丢弃有差错的帧。
  7. **检测连接状态**：自动检测链路是否出于正常工作状态。
  8. **最大传送单元**：PPP协议必须对每一种类型的点对点链路设置最大传送单元MTU的标准默认值。**MTU是数据链路层的帧可以载荷的数据部分的最大长度，而不是帧的总长度。**
  9. **网络层地址协商**：使通信的两个网络层的实体能够通过协商知道或配置彼此的网络层地址。
  10. **数据压缩协商**：PPP协议并不要求数据压缩算法进行标准化。
* **在TCP/IP协议中，可靠传输由TCP协议负责，因此数据链路层的PPP协议不需要进行纠错，不需要设置序列号，也不需要进行流量控制。**
* PPP协议**只支持点对点的链路通信、只支持全双工链路。**

### 3.2.1 PPP协议的组成（三部分）

1. 一个将IP数据报封装到串行链路的方法。IP数据报就是PPP帧中的信息部分，这个信息部分受MTU的限制。
2. 一个用来建立、配置和测试数据链路连接的链路控制协议LCP（Link Control Protocol）。
3. 一套网络控制协议NCP，其中的每一个协议支持不同的网络层协议。

### 3.2.2 PPP协议的帧格式

1. PPP帧的首部有是个字段，尾部有两个字段。
2. PPP帧的首部分别为：**0x7E, 0xFF, 0x03, 协议字段。**
3. 当**协议字段**为0x0021的时候，PPP帧的信息字段就是IP数据报。当**协议字段**为0xC021的时候，PPP帧的信息字段就是LCP的数据。当**协议字段**为0x8021的时候，PPP帧的信息字段就是控制数据。
4. 尾部的第一个字段是使用CRC的帧校验序列FCS。
5. **字节填充**：当**信息字段**中出现和**标志字段**一样的比特组合（0x7E）时，就必须采取一些措施使**和标志字段一样的比特组合不出现在信息字段中。**字节填充使得链路上的信息字节数超过了原来的信息字节数。在接收端载进行相反的变换，就能正确的恢复出原有的信息。
6. **零比特填充**：PPP协议在使用同步传输时（**一连串的比特连续发送而不是逐个字符地发送**），采用零比特填充的方法来实现**透明传输**。

### 3.2.3 PPP协议的工作状态

* 用户拨号接入ISP之后，电脑向ISP发送一系列链路控制协议LCP分组，以便建立LCP连接。接着进行网络层配置，网络控制协议NCP给新接入用户分配一个临时IP地址。

* 用户通信完毕，NCP释放网络层连接，收回原来分配出去的IP地址。接着，LCP释放数据链路层连接，最后释放物理层连接。PPP的状态包括：

  1. **链路静止**：用户电脑和ISP的路由器之间不存在物理层连接。
  2. **链路建立**：路由器检测到调制解调器发出的载波信号，双方建立了物理层连接。这时LCP开始协商一些配置选项，发送PPP协议的LCP配置请求帧。
  3. **鉴别状态**：发起通信的一方发送身份标识符和口令进行鉴别。若身份鉴别失败进入**链路终止**，若鉴别成功进入**网络层协议**状态。
  4. **网络层协议状态**：PPP链路两端的网络控制协议NCP根据网络层的不同协议相互交换网络层特定的控制分组。**PPP协议两端的网络层可以运行不同的网络层协议，但仍然可以使用同一个PPP协议进行通信。**
  5. **链路打开**：网络层配置完毕之后，链路就可以进行数据通信。链路的两个PPP端点可以彼此向对方发送分组。两个PPP端点还可以发送回送请求LCP分组和回送回答LCP分组，以检查链路状态。

  传输结束后，链路的一端发送**终止请求LCP分组**请求终止链路连接，在收到对方发来的**终止确认LCP分组**之后，链路转为**链路终止**状态。**当调制解调器的载波停止后，回到链路静止状态。**

* **从设备之间无链路开始，到先建立物理链路，再建立链路控制协议LCP链路。经过鉴别后再建立网络控制协议NCP链路，才能交换数据。由此可见，PPP协议已不是纯粹的数据链路层的协议，它还包含了物理层和网络层的内容。**



## 3.3 使用广播信道的数据链路层

* 共享信道要着重考虑的问题是**如何使众多用户能够合理而方便地共享通信媒体资源**。在技术上有两种方法：
  1. 静态划分信道：频分复用、时分复用、波分复用和码分复用。代价较高，不适合局域网。
  2. 动态媒体接入控制：多点接入，信道并非在用户通信时固定分配给用户。又分为以下两大类：
     * 随机接入：如果恰巧有两个用户在同一时刻发送消息，那么在共享媒体上就要发生碰撞，是的这些用户都会发送失败。
     * 受控接入：**分散控制的令牌环局域网**和**集中控制的多点线路探询**。

### 3.3.1 适配器（网卡）的作用

* 在网络是适配器上装有处理器和存储器（包含RAM和ROM），**适配器和局域网之间通过电缆或双绞线以串行传输方式进行。而适配器和计算机主板上的I/O总线以并行方式传输。**
* 适配器需要实现以太网协议。
* **计算机的硬件地址就在适配器的ROM中，而计算机的IP地址则在计算机的储存器中。**



### 3.3.2 CSMA/CD协议

* 总线的特点是：当一台计算机发送数据时，总线上的所有计算机都能检测到这个数据。这就是广播通信。

* 在发送数据帧时，在帧的首部写明接收站的地址。仅当数据帧中的目的地址与**适配器ROM**中存放的硬件地址一致时，该适配器才接收这个数据。**适配器对不是发送给自己的数据就丢弃。**

* 为了通信方便，以太网采取了以下两种措施：

  1. 采用较为灵活的无连接方式，不必先建立连接就可以直接发送数据。不进行编号，也不要求对方发回确认。**以太网提供的服务是尽最大努力交付，即不可靠的交付。对有差错的帧是否需要重传则由高层来决定。**如果高层确认要重传，**但以太网并不知道这是重传帧，而是当做新的数据帧来发送。**以太网以太网使用的是CSMA/CD，意思是载波监听多点接入/碰撞检测。
  2. 采用曼切斯特编码。当出现一长串的连1或连0时，接收端就利用电压的转换很方便地把同步信号提取出来。缺点就是频带宽度比原始的基带信号增加了一倍。

* CSMA/CD的特点：

  1. **多点接入**：总线型网络，协议的本质是**载波监听**和**碰撞检测**。
  2. **载波监听**：**不管在发送前，还是发送中，每个站都必须不停地检测信道。**如果检测出已经有其他站在发送，则自己就暂时不许发送数据，必须要等到信道变为空闲时才能发送。
  3. **碰撞检测**：**边发送边监听。**当适配器检测到信号电压变化幅度超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞。一旦发生了碰撞，适配器就立即停止发送，免得继续进行无效的发送，白白浪费网络资源。

  * **在使用CSMA/CD协议时，一个站不可能同时发送和接收（但必须边发送边监听）。**因此使用CSMA/CD协议的以太网不可能进行全双工通信而只能进行**半双工通信。**
  * 适配器每发送一个新的帧，就要执行一次CSMA/CD算法。适配器对过去发生过的碰撞并无记忆功能。
  * **以太网规定了一个最短帧长64字节，如果要发送的数据非常少，就必须加入一些填充字节，使帧长度不小于64字节。**
  * **如果发生碰撞，就一定是在发送的强64字节之内。**由于一检测到冲突就立即中止发送，这时已经发送出去的数据一定小于64字节，因此**凡是长度小于64字节的帧都是由于冲突而异常中止的无效帧。**
  * **强化碰撞**：发送数据的站一旦发现了碰撞，除了立即停止发送数据外，还要再继续发送一个32比特或48比特的人为干扰信号，以便让所有用户都知道现在已经发生了碰撞。
  * CSMA/CD协议的要点：
    1. 准备发送：适配器从网络层获得一个分组，加上以太网的首部和尾部，组成以太网帧，放入适配器缓存中。**发送之前先检测信道。**
    2. 检测信道：以太网规定了帧间最小间隔9.6μs，相当于96比特的时间。若检测到信道忙，则应不停地检测，一直等待信道转为空闲。**若检测到信道空闲，并在96比特时间内信道保持空闲，就发送这个帧。**
    3. 在发送的过程中不停地检测信道，即网络适配器要**边监听边发送。**在争用期内一直未检测到碰撞，则发送成功，**回到第1步**。若检测到碰撞，立即停止发送数据，执行指数退避算法，回到步骤2，继续检测信道。若重传16次仍然不能成功，则停止重传并向上报错。
  * 以太网每发送完一帧，一定要把已发送的帧暂时保留一下，如果在争用期内检测出碰撞，那么还要在推迟一段时间后把这个保留的帧重传一次。



### 3.3.3 使用集线器的星型拓扑

* 星型拓扑的中心使用集线器。双绞线以太网和集线器总是配合使用的。双绞线的两端使用RJ-45插头。
* **10BASE-T双绞线以太网的出现，是局域网发展史上的一个非常重要的里程碑。从此以太网的拓扑就从总线型变为星型，而以太网也就值局域网中占据了统治地位。**
* **使用集线器的以太网在逻辑上仍然是一个总线网，各站共享逻辑上的总线，使用的还是CSMA/CD协议。**网络中各站必须竞争对传输媒体的控制，并且在同一时刻至多只允许一个站发送数据。
* 一个集线器有许多接口。**因此，一个集线器很想多接口的转发器。**
* **集线器工作在物理层**。每个接口仅仅简单地转发比特，**不进行碰撞检测**。若两个接口同时有信号输入（即发生碰撞），那么所有的接口都将收不到正确的帧。
* 集线器采用了专门的芯片，进行自适应串音回波抵消。
* 当扣除碰撞所造成的信道损失后，以太网的总信道利用率并不能达到100%。

### 3.3.4 以太网的MAC层

* **名字指出我们所要寻找的那个资源，地址指出那个资源在何处，路由告诉我们如何到达该处。**
* **严格地讲，名字应当与系统所在地无关。**
* 48位的MAC地址，固化在适配器的ROM中。
* MAC地址也叫作硬件地址或物理地址，实际上就是适配器地址或适配器标识符。当这块适配器插入到某台计算机后，适配器上的标识符就成为这台计算机的MAC地址。
* 所有的适配器都至少能够识别**单播**和**广播**帧。**当操作系统启动时，它就把适配器初始化，使适配器能够识别某些多播地址。**
* 以太网MAC帧格式：目的地址\6、源地址\6、类型\2、数据部分\46-1500、FCS\4。
* 当数据字段的长度小于46字节,MAC层就会在数据字段的后面加入一个整数字节的填充字段，以保证以太网的MAC帧长度不小于64字节。**在接收端，MAC子层在去掉首部和尾部之后，就把数据字段和填充字段一起交给上层协议。**
* MAC子层在将MAC帧向下传递到物理层的时候会在帧的前面添加8字节，由硬件生成。这个添加的字节叫做**前同步码**，作用是使接收端的适配器在接收MAC帧时能够迅速调整时钟频率，使接收端和发送端时钟同步。
* **在以太网传送数据时是以帧为单位传送的。以太网在传送帧时，各帧之间还必须有一定的间隙。因此，接收端只要找到帧开始界定符，其后面的连续到达的比特流就都属于同一个MAC帧。可见以太网不需要帧结束界定符，也不需要使用字节插入来保证透明性。**



## 3.4 扩展的以太网

* 两个网段使用一个转发器连接起来，这种网络在网络层看起来仍然是一个网络。
* 扩展以太网更常用的是网桥。网桥对收到的MAC帧的目的地址进行转发和过滤。根据此帧的目的MAC地址，查找网桥中的地址表，然后确定将该帧转发到哪一个接口，或者把它丢弃。1990年问世的**交换式集线器**，很快就淘汰了网桥。**交换式集线器常称为以太网交换机，这种交换机工作在数据链路层。**

### 3.4.4 以太网交换机的特点

1. 本质上是一个多接口网桥。以太网交换机的每个接口都直接与一个单台主机或另一个以太网交换机相连，并且一般都工作在全双工方式。**以太网交换机还具有并行性，即能同时连通多对接口，使多对主机能同时通信。相互通信的主机都是独占传输媒体，无碰撞地传输数据。**
2. 以太网交换机是一种即插即用的设备，其内部的帧交换表是**通过自学习算法自动逐渐建立起来。**以太网交换机使用了专门的交换接口芯片，**用硬件转发**，转发速率比使用软件转发的网桥快很多。
3. 虽然许多以太网交换机对收到的帧采用存储转发方式进行转发，但也有一些交换机采用直通的交换方式。**直通交换不必把整个数据帧先缓存下来再进行转发处理，而是在接收到帧的同时就立即按数据帧的目的MAC地址决定该帧的转发接口，提高了准发速度。**这种交换机内部采用基于硬件的交叉矩阵，交换时延就非常小。
4. 交换机的自学习功能。交换表中的每个项目都设有一定的时间。过期的项目都将被自动删除。这样可以保证交换表中的数据都符合当前网络的实际状况。**为了解决转发时兜圈子问题，IEEE的802.1D标准制定了生成树协议。**其特点时不改变网络的实际拓扑，但在逻辑上切断某些链路，使得一台主机到其他主机的链路无环路。
5. **总线以太网使用CSMA/CD协议，以半双工通信。而以太网交换机不使用共享总线，不使用CSMA/CD协议，没有碰撞问题，以全双工方式通信。**
6. 虚拟局域网（VLAN）：每一个VLAN帧都由一个明确的标识符，指明发送这个帧的计算机属于哪一个VLAN。VLAN限制了接收广播信息的计算机数，使得网络上不会出现广播风暴。
7. 虚拟局域网协议允许以太网的帧格式中插入一个4字节的标识符，用来指明发送该帧的计算机属于哪一个VLAN。

## 3.5 高速以太网

* 1999年公布的PPPoE，把PPP协议中的PPP帧再封装到以太网中来传输。**现在的FTTx都要使用PPPoE的方式来接入。**
* 当用户使用ADSL（非对称数字用户线）进行宽带上网时，电脑到ADSL调制解调器之间用RJ-45线进行连接，并且也是用PPPoE弹出的窗口进行拨号的。但是用户电脑发出的以太网帧到了ADSL调制解调器之后，就转换成为ADSL使用的PPP帧。

## 本章重要概念

1. 数据链路层使用的信道主要有点对点信道和广播信道两种。
2. 数据链路层传送的协议数据单元是帧。单个基本准则：封装成帧、透明传输和差错检测。
3. 点对点协议PPP是数据链路层使用最多的一种协议。特点是：简单、不使用序号、同时支持多种网络层协议。
4. PPPoE为宽带上网的主机使用的链路层协议。
5. 局域网的优点：具有广播功能；便于系统的扩展和演变。
6. 共享媒体资源的方法：静态划分信道（各种复用技术）；动态媒体接入控制（随机接入和受控接入）。
7. 计算机与外界局域网的通信要通过通信适配器，又叫网卡。计算机的硬件地址就在适配器的ROM中。
8. 以太网采用的协议是具有冲突检测的载波监听多点接入CSMA/CD协议。协议的要点：**发送前先监听，边发送边监听，一旦发现总线上出现了故障，就立即停止发送。然后按照退避算法等待一定时间再次发送。因此，每一个站在自己发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。**以太网上各站之间平等地竞争以太网信道。
9. 双绞线以太网，物理上是星型网，逻辑上是总线型网。集线器工作在物理层，每个接口仅仅简单转发比特，不进行碰撞检测。
10. 以太网的硬件地址，也就是网络适配器的MAC地址。在网卡的ROM中。
11. 以太网交换机，每个接口与一台主机相连，全双工工作，使一对通信的主机独占通信媒体，无碰撞地传输数据。





# 四、网络层

* 网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务。网络在发送数据报时不需要先建立分组。每一个数据报独立发送，与其前后的分组无关。网络层不提供服务质量的承诺。由于网络层，所传送的数据报可能出错、丢失、重复或失序，这就使得网络中的路由器比较简单。
* 采用这种设计思路的好处就是：网络造价大大降低，运行方式灵活，能够适应多种应用。互联网能够发展到今天的规模，充分证明了当初采用这种设计思路的正确性。

## 4.1 网际协议IP

* 与IP协议配套使用的还有三个协议：
  1. **地址解析协议ARP**；
  2. **网际控制报文协议ICMP**；
  3. **网际组管理协议IGMP;**
* 将网络互连起来的设备叫做中间设备：
  1. 物理层使用的中间设备叫做**转发器；**
  2. 数据链路层使用的中间设备叫做**网桥或桥接器**；
  3. 网络层使用的中间设备叫做**路由器；**
  4. 网络层以上使用的中间设备叫做**网关**。用网关连接两个不兼容的系统需要在高层进行协议的转换。
* **当中间设备是转发器或网桥时，这仅仅是把一个网络扩大了，而从网络层的角度看，则仍然是一个网络，一般并不称为网络互连。**
* 使用IP协议就可以让性能各异的网络在网络层上看起来好像是一个统一的网络。互联网可以由多种异构网络互连组成。

### 4.1.1 分类的IP地址

* IP地址的编址方法共经过了三个历史阶段：**分类的IP地址、子网的划分、构成超网。**
* 从IP地址的结构来看，IP地址并不仅仅指明一台主机，而是还指明了主机所连接到的网络。
* 每一个IP地址都由网络号和主机号两部分组成。从这个意义上，IP地址是一种分等级的地址结构。**路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目的主机号），这样就可以使路由表中的项目数大大减少，从而减少了路由表所占的存储空间以及查找路由表的时间。**
* **实际上IP地址是标志一台主机（或路由器）和一条链路的接口。**当一台主机同时连接到两个网络上时，该主机就必须同时具有两个相应的IP地址，其网络号必须是不同的。**由于一个路由器至少应当连接到两个网络，因此一个路由器至少应当有两个不同的IP地址。**
* **用转发器或网桥连接起来的若干个局域网仍为一个网络。**因为这些局域网都具有同样的网络号。具有不同网络号的局域网必须使用路由器进行互连。
* **在一个局域网上的主机或路由器的IP地址中的网络号必须是一样的。**
* **用网桥（它只在链路层工作）互连的网段仍然是一个局域网，只能有一个网络号。**路由器总是具有两个或两个以上的IP地址。即路由器的每一个接口都由一个不同网络号的IP地址。

### 4.1.2 IP地址与硬件地址

* **物理地址是数据链路层和物理层使用的地址，而IP地址是网络层和以上各层使用的地址，是一种逻辑地址**（IP地址是用软件实现的）。
* 使用IP地址的IP数据报一旦交给了数据链路层，就被封装成MAC帧了。MAC帧在传送时使用的源地址和目的地址都是**硬件地址**，这两个硬件地址都写在MAC帧的首部中。
* IP地址放在IP数据报的首部，硬件地址放在MAC帧的首部。网络层和网络层以上使用的是IP地址，而数据链路层及以下使用的是硬件地址。当IP数据报放入数据链路层的MAC帧中以后，整个的IP数据报就成为MAC帧的数据部分，因而在数据链路层看不见数据报的IP地址。
  1. **在IP层抽象的互联网上只能看到IP数据报。**数据报中间经过的两个路由器的IP地址并不出现在IP数据报的首部中。
  2. 路由器根据目的IP地址的**网络号**进行路由选择。
  3. 在局域网的链路层，只能看见MAC帧。IP数据报被封装在MAC帧中。MAC帧在不同的网络上传送时，其MAC帧首部中的源地址和目的地址要发生变化。
  4. 尽管互连在一起的网络的硬件地址体系各不相同，**但IP层抽象的互联网却屏蔽了下层这些复杂的细节。只要我们在网络层上讨论问题，就能够使用统一的、抽象的IP地址研究主机和主机或路由器之间的通信。**

### 4.1.3 地址解析协议ARP

* 地址解析协议ARP：已经知道了一个机器（主机或路由器）的IP地址，需要找出其相应的硬件地址。
* ARP协议的用途就是为了从**网络层**使用的IP地址，解析出在**数据链路层**使用的硬件地址。
* 网络层使用的是IP地址，但是在实际网络的链路上传送数据帧时，最终还是必须使用该网络的硬件地址。但IP地址和下面的网络硬件地址之间由于格式不同而不存在简单地映射关系。**地址解析协议ARP解决这个问题的方法是在主机ARP高速缓存中存放一个从IP地址到硬件地址的映射表，并且这个映射表还经常动态更新。**
* 每一台主机都设有一个ARP高速缓存，里面有本局域网上的各主机和路由器的IP地址到硬件地址的映射表，这些都是该主机目前知道的一些地址。
* **为了减少网络上的通信量，主机A在发送其ARP请求分组时，就把自己的IP地址到硬件地址的映射写入ARP请求分组。当主机B收到A的ARP请求分组时，就把主机A的这一地址映射写入主机B自己的ARP高速缓存中。**以后主机B向A发送数据报时就很方便了。
* ARP对保存在高速缓存中的每一个映射地址项目都设置**生存时间**。凡超过生存时间的项目就从高速缓存中删除掉。
* ARP是解决**同一个局域网**上的主机或路由器的IP地址和硬件地址的映射问题。
* 从IP地址到硬件地址的解析是自动进行的，**主机的用户对这种地址解析过程是不知道的**。
* 一个IP数据报由首部和数据两部分组成。首部的前一部分是固定长度，共20字节，是所有IP数据报必须具有的。在首部的固定部分的后面是一些可选字段，**其长度时可变的。**

### 4.1.4 IP层转发分组的流程

* 当路由器收到一个待转发的数据报，在从路由表得出下一跳路由器的IP地址后，**不是把这个地址填入IP数据报，而是交数据链路层的网络接口软件。**网络接口软件负责把下一跳路由器的IP地址转换成硬件地址（ARP），并将此硬件地址放在链路层的MAC帧首部，然后根据这个硬件地址找到下一跳路由。
* 当发送一连串的数据报时，这种路由查找表、用ARP得到硬件地址、把硬件地址写入MAC帧的首部等过程，将不断地重复进行，造成了一定的开销。**使用抽象的IP地址，本来就是为了隐蔽各种底层网络的复杂性而便于分析和研究问题，这样就不可避免地要付出一些代价。**反过来，如果使用硬件地址，却会带来更多地麻烦。
* **路由表并没有给数据报指明到某个网络的完整路径。**路由表指出，到某个网络应当先到某个下一跳路由器，到达下一跳路由器之后，再继续查找其路由表，直到再下一步路由器。这样一步一步地查找下去，直到最终达到目的。

## 4.2 划分子网和构造子网

### 4.2.1 从两级IP地址到三级IP地址

* 两级IP地址的目前存在的问题：

  1. **IP地址空间的利用率有时很低：**有的单位申请到了一个B类网络地址，但所连接的主机数并不多，可是又不愿意申请一个足够使用的C类地址，理由是考虑到今后可能的发展。
  2. 给每一个物理网络分配一个网络号会**使路由表变得太大**，因而使网络性能变坏。
  3. 两级IP地址不够灵活：**使一个单位能随时灵活地增加本单位的网络，而不必事先到互联网管理机构去申请新的网络号。**

  为了解决上述问题，从1985年起在IP地址中又增加了一个**“子网号字段”**，使两级IP变成三级IP。这种做法叫做**划分子网**，或**子网寻址**或**子网路由选择**。

* 一个拥有许多物理网络的单位，可见所属的物理网络划分为若干**子网**。划分子网纯属一个单位内部的事情。本单位以外的网络**看不见**这个网络是由多少个子网组成，因为这个单位**对外仍然表现为一个网络。**

* 划分子网的方法是从网络的**主机号**借用若干位作为**子网号**，当然主机号也就相应减少了同样的位数。于是两级IP地址在**本单位内部**就变成了**三级IP**地址：网络号、子网号和主机号。

* 凡是从其他网络发送给本单位某台主机的IP数据报，仍然是**根据IP数据报的目的网络号找到连接在本单位网络上的路由器**。但此路由器在收到IP数据报后，**再按目的网络号和子网号找到目的子网，**把IP数据报交付目的主机。

* 划分子网只改变IP地址的**主机号**，不改变网络号。



### 4.2.2 子网掩码

* 从IP数据报的首部无法看出源主机或目的主机所连接的网络是否进行子网划分。但是从**子网掩码**却可以看出来。
* 使用子网掩码的好处：不管网络有没有划分子网，只要把子网掩码和IP地址进行**逐位“与”**，就可以得出所要找的子网的网络地址。这样在路由器处理到来的IP数据报时就可采用同样的算法。
* **现在的互联网规定：所有的网络都必须使用子网掩码，同时在路由器的路由表中也必须有子网掩码这一栏。**
* **子网掩码是一个网络或一个子网的重要属性。**路由器在和相邻路由器交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉相邻路由器。**若一个路由器连接在两个子网上，就拥有两个网络地址和两个子网掩码。**
* 若使用较少位数的子网号，则每一个子网上可连接的主机数就较多。若使用较多位数的子网号，则子网的数目较多当每个子网上可连接的主机数较少。**划分子网增加了灵活性，当却减少了能够连接在网络上的主机总数。**



### 4.2.3 使用子网时的分组转发

* 使用子网划分后，路由表必须包含以下三项内容：**目的网络地址、子网掩码、下一跳地址。**
  1. 从收到的IP数据报的首部提前目的IP地址D。
  2. 先判断是否为直接交付。**用各网络的子网掩码和D逐位相与，看结果是否和相应的网络地址匹配。若匹配，则把分组进行直接交付（把IP地址D转换成物理地址，把数据报封装成帧发送出去）。转发任务结束。**否则进行下一步3.
  3. 对路由表的每一行（**目的网络地址、子网掩码和下一跳地址**），用其中的子网掩码与D逐位与。若结果与该行的目的网络地址匹配，则把数据包传送给改行指明的**下一跳路由**。
  4. 若路由表中有一个默认路由，就将IP数据报往默认路由转发。
* 2011年2月3日，IAN宣布IPV4地址已经耗尽了。
* **最长匹配前缀**：在使用CIDR时，由于采用了网络前缀这种记法，IP地址由网络前缀和主机号这两个部分组成，因此在路由表中的项目也要有相应的改变。这时，每个项目由**网络前缀**和**下一跳地址**组成。但是在查找路由表时可能得到不止一个匹配结果。**应当从匹配结果中选择具有最长网络前缀的路由，**因为最长前缀匹配最长，其地址块就越小，因而路由就越具体。**CIDR的使用已经推迟了IP地址耗尽的日期。**



## 4.4 网际控制报文协议ICMP

* 为了更有效地转发IP数据报和提高交付成功的机会，在网际层使用了**网际控制报文协议ICMP。**
* ICMP是互联网的标准协议。但ICMP不是高层协议，是装在IP数据报中，作为其IP数据报的数据部分。ICMP报文作为装在IP数据报的数据，加上数据报的首部，组成IP数据报发送出去。

* ICMP报文的种类有两种，即**ICMP差错报告报文**和**ICMP询问报文**。
* **ICMP差错报告报文：**终点不可达、时间超过、参数问题和改变路由（重定向）。
* **ICMP询问报文：**回送请求和问答、时间戳请求和回答。

* ICMP的一个重要应用就是分组网间探测**PING**，用来测试两台主机之间的连通性。另一个用来跟踪数据报从源点到终点的路径**traceroute**，Windows下用**tracert**.

## 4.5 互联网的路由选择协议

* 互联网采用的路由选择协议主要是自适应的（动态的）、分布式的路由选择协议。由于以下两个原因，互联网采用分层次的路由选择协议：
  1. 互联网的规模非常大。
  2. 许多单位不愿意外界了解自己单位网络的布局细节和本部门采用的路由选择协议，当同时还希望连接到互联网上。
* 目前，把互联网划分为许多较小的**自治系统**（AS）。自治系统AS是在单一技术管理下的一组路由器，而这些路由器使用一种自治系统内部的路由选择协议和共同的度量。**一个AS对其他AS表现出的是一个单一的一致的路由选择策略。**
* 互联网把路由选择协议划分为两大类：**内部网关协议**和**外部网关协议**。自治系统之间的路由选择也叫做**域间路由选择**，而在自治系统内部的路由选择叫做**域内路由选择。每个自治系统都由一个或多个路由器除运行本系统的内部路由选择协议外，还要运行自治系统间的路由选择协议。**
* **内部网关协议**：如RIP和OSPF等。**外部网关协议：**如BGP。

### 4.5.1 内部网关协议RIP

* RIP是一种分布式的基于距离向量的路由选择协议，是互联网的标准协议，其最大的优点就是简单。

* **RIP协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录（距离向量）。**

* RIP协议的“距离”也称为**“跳数”**。RIP允许一条路径最多只能包含15个路由器，当距离等于16时即相当于不可达。**RIP选择一条具有最少路由器的路由，哪怕还存在另一条高速低延时但路由器较多的路由。**

* RIP的特点：

  1. **仅和相邻路由器交换信息**。RIP协议规定，不相邻的路由器不交换信息。
  2. **路由器交换的信息是当前本路由所知道的全部信息，即自己现在的路由表。**也就是“我到本自治系统中所有网络的最短距离，以及到每个网络应经过的下一条路由器。”
  3. **按固定的时间间隔交换路由信息。**

  路由器在**刚刚开始工作时**，它的路由表是空的。每个路由器也只和数目非常有限的相邻路由器交换并更新路由信息。但经过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的最短路径和下一跳路由器的地址。

* 在一般情况下，RIP协议可以**收敛**，而且过程比较快。**收敛**就是在自治系统中所有的结点都得到正确的路由选择信息的过程。路由表中最主要的信息就是：**到某个网络的（距离）距离，以及应经过的下一跳地址。路由表更新的原则是找出到每个目的网络的最短距离。**这种更新算法又称为**距离向量算法**。

* RIP协议让一个自治系统的所有路由器和自己的相邻路由器定期交换路由信息，并不断更新其路由表，使得**从每一个路由器到每一个目的网络的路由都是最短的（即跳数最少）。**虽然所有的路由器最终都拥有了整个自治系统的全局路由信息，但由于每一个路由器的位置不同，**他们的路由表当然也应当不同。**

* **RIP协议使用运输层的用户数据报UDP进行传送（端口是520）。**RIP报文由首部和路由部分组成，首部占4个字节，其中的命令字段指出报文的意义。

* **RIP存在的一个问题是当网络出现故障时，要经过比较长的时间才能将此信息传送到所有的路由器。**因为每个路由器只和自己相邻的路由器发送信息。

* **RIP协议的特点叫做：好消息传播得快，而坏消息传播得慢。**因此当网络出故障的传播时间往往需要较长的时间（数分钟）。但如果一个路由器发现了更短的路由，那么这种更新信息就传播得很快。

### 4.5.2 内部网关协议OSPF

* **开放最短路径优先（OSPF）使用了Dijkstra提出的最短路径算法SPF。**OSPF最主要的特征就是使用分布式的**链路状态协议**，而不是像RIP那样的距离向量协议。和RIP协议相比，OSPF的三个要点和RIP都不一样：

  1. 向本自治系统中**所有路由器**发送信息。使用的方法是**洪泛法**，路由器通过所有输出端口向所有相邻的路由器发送信息。而每一个相邻路由器又再将此信息发送其所有的相邻路由器（但不再发送给刚刚发来信息的那个路由器 ）。最终，整个区域中所有的路由器都得到了这个信息的一个副本。而RIP协议仅仅向自己相邻的几个路由器发送信息。
  2. 发送的信息就是**本路由器相邻的所有路由器的链路状态。**但这只是路由器所知道的部分信息。所谓“链路状态”就是说明本路由器都和哪些路由器相邻，以及该链路的**度量**。OSPF将这个“度量”用来表示费用、距离、时延、带宽。有时为了方便就称这个度量为**“代价”**。
  3. **只有当链路状态发生变化时，路由器才向所有路由器用洪泛法发送此信息。**而不像RIP那样，不管网络拓扑有无变化，路由器之间都要定期交换路由表的信息。
* 由于各路由器之间频繁地交换链路状态信息，因此所有的路由器最终都能建立一个**链路状态数据库**，这个数据库实际上就是全网的**拓扑结构图**。这个拓扑结构图在全网范围内是一致的。每一个路由器都知道全网共有多少个路由器，以及哪些路由器是相连的，其代价是多少。**RIP协议的每一个路由器虽然知道到所有的网络的距离以及下一跳路由器，但却不知道全网的拓扑结构。**（只有到了下一跳路由器，才能知道再下一跳应当怎样走）
* **OSPF**的链路状态数据库能较快地进行更新，使各个路由器能及时更新其路由表。**OSPF**将一个自治系统再划分为若干个更小的范围，叫做**区域**。划分区域的好处就是把利用洪泛法交换链路状态信息的范围局限于每一个区域而不是整个的自治系统，这就减少了整个网络上的通信量。
* **OSPF**使用层次结构的区域划分。在上层的区域叫做**主干区域**。主干区域的作用是用来连通其他在下层的区域。从其他区域来的信息都是**区域边界路由器**进行概括。每一个区域至少应当有一个区域边界路由器。在主干区域内的路由器叫做**主干路由器。**另外在自治系统之间交换信息的路由器又叫**自治系统边界路由器。**
* 采用分层次划分区域的方法虽然使交换信息的种类增多了，同时也使OSPF协议更加复杂了。但这样做却能使每一个区域内部交换路由信息的通信量大大减少了，**因而使OSPF协议能够用于规模很大的自治系统中。**这里，我们看到划分层次在网络设计中的重要性。
* **OSPF不用UDP，而是直接使用IP数据报传送。**OSPF的数据报很短，好处是不必将长的数据报分片传送。除此之外，OSPF还具有下列的一些特点：
  1. OSPF允许管理员给每条路由指派不同的代价，对于不同业务类型可计算出不同的路由。
  2. 如果到同一个目的网络有多条相同代价的路径，可以将通信量分配给这几条路径，这叫做多路径间的**负载平衡**。**RIP只能找出到某个网络的一条路径。**
  3. 所有在OSPF路由器之间交换的分组都具有**鉴别功能**，因而保证了仅在可信赖的路由器之间交换链路状态信息。
  4. OSPF支持可变长度的子网划分和无分类的编址CIDR。
  5. 由于网络中的链路状态可能经常发生变化，因此OSPF让每一个链路状态都带上一个32位的**序号**，序号越大状态就越新。
* OSPF共有以下五种数据报类型：
  1. **问候**：用来发现和维持邻站的可达性；
  2. **数据库描述**：向邻站给出自己的链路状态数据库中的所有链路状态项目摘要信息；
  3. **链路状态请求**：向对方发送某些链路状态项目的详细信息；
  4. **链路状态更新**：用洪泛法对全网更新链路状态，这种分组时最复杂的，也是OSPF协议最核心的部分。
  5. **链路状态确认**：对链路更新分组的确认。
* OSPF规定，相邻路由器每隔**10秒钟**要交换一次**问候分组**。这样就能明确哪些邻站是可达的。正常情况下，网络中传送的绝大多数OSPF分组都是问候分组。若40秒钟没有收到某个相邻路由器发来的**问候分组**，则可认为该相邻路由器是不可达的，**应立即修改链路状态数据库，并重新计算路由。**
* 其他四种分组都是用来进行链路状态数据库同步的。所谓**同步**就是指不同路由器的链路状态数据库的内容是一样的。两个同步的路由器叫做**完全邻接路由器**。
* **OSPF让每一个路由器用数据库描述分组和相邻路由器交换本数据库中已有的链路状态摘要信息。摘要信息主要就是指出有哪些路由器的链路状态信息（以及其序号）已经写入了数据库。**经过与相邻路由器交换数据库描述分组后，路由器就使用链路状态请求分组，向对方请求发送自己所缺少的某些链路状态项目的详细信息。通过这一系列的分组交换，全网同步的链路数据库就建立了。
* 在网络运行的过程中，**只要一个路由器的链路状态发生变化，该路由器就要使用链路状态更新分组，用洪泛法向全网更新链路状态。**OSPF使用的是可靠的洪泛法。路由器在收到分组进行转发时，要将其上游路由器除外。可靠的洪泛法是在收到更新分组后要发送确认。
* **由于一个路由器的链路状态只涉及到与相邻路由器的连通状态，因而与整个互联网的规模并无直接关系。**因此当互联网规模很大时，OSPF协议要比距离向量协议RIP好得多。由于OSPF没有**“坏消息传播慢”**的问题，其网络变化的时间小于100ms。
* OSPF协议对多点接入的局域网采用了**指定的路由器**的方法，是广播的信息量大大减少了。

### 4.5.3 外部网关协议BGP

* 使用边界网关协议BGP的原因：
  1. 互联网的规模太大，使得自治系统AS之间路由选择非常困难。**如果使用链路状态协议，则每一个路由器必须维持一个很大的链路状态数据库。**由于自治系统AS各自运行自己选定的内部路由选择协议，并使用AS指明的路径度量。因此，当一条路径通过几个不同的AS时，要想对这样的路径计算出有意义的代价不太可能。**比较合理的做法是在自治系统之间交换“可达性”信息。**
  2. 自治系统AS之间的路由选择必须考虑有关策略。**由于相互连接网络的性能相差很大，根据最短距离找出来的路径，可能并不适合。**

* 因此，边界网关协议BGP**只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由。**

* **BGP采用了路径向量路由选择协议**，它与**距离向量协议RIP**和**链路状态协议OSPF**都由很大差别。

* 在配置BGP时，每一个自治系统的管理员要选择至少一个路由器作为该自治系统的**BGP发言人。**然后在此连接上交换BGP报文以建立**BGP会话**，从而交换路由信息。

* **每一个BGP发言人除了运行BGP协议外，还必须运行该自治系统所使用的内部网关协议，如OSPF和RIP。**

* 边界网关协议BGP所交换的网络可达性信息就是要到达某个网络所要经过的一系列自治系统。各BGP发言人就根据所采用的策略从收到的路由信息中找出到达各自治系统的较好路由。它是树形结构，不存在回路。

* BGP协议交换路由信息的结点数量级是**自治系统个数**的量级。这要比这些自治系统中的**网络数**少的多。

* BGP支持无分类域间路由选择协议CIDR，因此BGP的路由表也就应当包括目的**网络前缀、下一跳路由器，以及到达该目的网络所要经过的自治系统序列**。如果一个BGP发言人收到了其他BGP发言人发来的路径通知，它就要检查一下本自治系统是否在此通知的路径中。**如果在这条路径中，就不能采用这条路径（应该在下一跳路由中）。**

* **在BGP刚刚运行时，BGP的邻站是交换整个BGP路由表。但以后只需要在发生变化时更新有变化的部分。**这样做对节省网络带宽和减少路由器的处理开销方面都由好处。

* 在RFC 4271中规定了BGP-4的四种报文：

  1. **OPEN（打开）报文**：用来与相邻的另一个BGP发言人建立关系，使通信初始化；
  2. **UPDATE（更新）报文**：用来通告某一路由信息，以及列出要撤销的多条路由；
  3. **KEEPALIVE（保活）报文**：用来周期性地证实邻站的连通性；
  4. **NOTIFICATION（通知）报文**：用来发送检测到的差错。

* 一开始向邻站进行商谈时就必须发送**OPEN报文**。如果邻站接受这种邻站关系，就用**KEEPALIVE报文响应**。这样，两个BGP发言人的邻站关系就建立了。为了维持邻站关系，两个BGP发言人彼此周期性地交换**KEEPALIVE报文（一般每隔30秒）**。BGP发言人可以用**UPDATE报文撤销它以前曾经通知过的路由，也可以宣布增加新的路由。**撤销路由可以一次性撤销许多条，当增加新路由每个报文只能增加一条。由于BGP发言人可以从不止一个邻站获得路由信息，因此可以很容易选择出新的路由**（可以很容易解决距离向量路由选择算法中的“坏消息传播得慢”的问题）**。

### 4.5.4 路由器的构成

* 路由器是一种具有多个输入端口和多个输出端口的专用计算机，其任务是**转发分组**。路由器的**转发分组**正是网络层的主要工作。
* 整个的路由器结构可划分为两大部分：**路由选择**部分和**分组转发**部分。
* **路由选择**部分也叫做**控制部分**，其核心构件是路由选择处理机。任务是根据所选定的路由选择协议构造出路由表，同时经常或定期地和相邻路由器交换路由信息而**不断地更新和维护路由表**。
* **分组转发**部分由三部分构成：**交换结构、一组输入端口和一组输出端口**。交换结构根据**转发表**对分组进行处理，将某个输入端口进入的分组从一个合适的输出端口转发出去。交换结构本身就是一种网络，但这种网络完全包含在路由器之中，因此交换结构可看成是**“在路由器中的网络”**。
* **“转发”和“路由选择”是有区别的。**在互联网中，**“转发”**就是路由器根据转发表把收到的IP数据报从路由器合适的端口转发出去。**转发**仅仅涉及到一个路由器。但**“路由选择”**则涉及到很多路由器，路由表则是许多路由器协同工作的结果。**路由表**一般仅包含从目的网络到下一跳的映射，而**转发表**是从路由表得出的。**转发表必须包含完成转发功能所必须的信息。转发表的每一行必须包含从要到达的目的网络到输出端口和某些MAC地址信息的映射。**转发表的结构应当使查找过程最优化，但路由表则需要对网络拓扑变化的计算最优化。**路由表总是用软件实现的，但转发表则甚至可用特殊的硬件来实现。**
* **输入端口中的查找转发表和转发功能在路由器的交换功能中是最重要的。**为了使交换功能分散化，往往把复制的转发表放在每一个输入端口中。路由选择处理机负责对各转发表的副本进行更新。这些副本常称为“**影子副本**”。
* 输出端口从交换结构接收分组，然后把它们发送到路由器外面的线路上。在网络层的处理模块中设有一个缓冲区。**数据链路层处理模块把分组加上链路层的首部和尾部，交给物理层后发送到外部线路。**
* 本书之前提到过的**分组丢失**就是发生在路由器中的输入或输出队列**产生溢出**的时候。
* **交换结构**：
  1. 三种常见的交换方法：**通过存储器、通过总线和通过互连网络。**
  2. 许多现代的路由器是通过**存储器**进行交换的。与早期的路由器的区别就是，**目的地址的查找**和**分组在存储器中的缓存**都是在输入端口中进行的。



## 4.6 IPv6

* 解决IP地址耗尽的根本措施就是采用具有更大地址空间的新版本IP，即IPv6。
* IPv6仍支持无连接的发送，但将协议数据单元PDU称为**分组**。
* 一般来讲，一个IPv6数据报的目的地址可以是以下三种基本类型地址之一：
  1. **单播**：传统的点对点通信。
  2. **多播**：IPv6没用采用广播的术语，而是将广播看做多播的一个特例。
  3. **任播**：这是IPv6增加的一种类型。任播的终点是一组计算机，但数据报只交付其中一个，通常是距离最近的一个。
* IPv6把实现IPv6的主机和路由器均称为结点。这样，IPv6给结点的每一个接口指派一个IP地址。一个结点可以有多个单播地址，而其中任何一个地址都可以当作到达该结点的目的地址。

### 4.6.1 从IPv4向IPv6的过渡

* 向IPv6过渡只能采用逐步演进的办法 ，同时，还必须使新安装的IPv6系统能够向后兼容。一般采用**双协议栈**和**使用隧道技术**。
* **双协议栈**：
  1. 使一部分主机（或路由器）装有双协议栈。
  2. 为了区分双协议栈主机（或路由器）采用的是IPv4还是IPv6。它使用域名系统DNS来查询。若DNS返回的是IPv4地址，双协议栈的源主机就使用IPv4。同理，则使用IPv6。
  3. 转换后，IPv6首部中的**某些字段无法恢复**。
* **隧道技术**：
  1. 把IPv6数据报封装成为IPv4数据报。现在整个的IPv6数据报就变成了IPv4数据报的数据部分。

### 4.6.2 ICMPv6

* IPv6也需要使用ICMP来反馈一些差错信息。新的版本成为ICMPv6，它比ICMPv4要复杂得多。地址解析协议ARP和网际组管理协议IGMP的功能都已被合并到了ICMPv6。
* ICMPv6是面向报文的协议，它利用报文来报告差错，获取信息，探测邻站或管理多播通信。
* ICMPv6报文分类：**差错报文、信息报文、邻站发现报文和组成员关系（多播听众交付MLD）报文**。

## 4.7 IP多播

* 在互联网范围的多播要靠路由器来实现，这些路由器必须增加一些能够识别多播数据报的软件。能够运行多播协议的路由器称为**多播路由器**。
* 在互联网上进行多播就叫做**IP多播**。IP多播所传送的分组需要使用IP多播地址。
* 多播数据报的目的地址写入的是**多播组的标识符（D类IP地址）**，然后设法让加入到这个多播组的IP地址与多播组的标识符关联起来。
* 多播数据报也是“尽最大努力交付”，不保证一定能够交付多播组内的所有成员。**多播数据报和一般的IP数据报的区别就是它使用D内IP地址作为目的地址，并且首部中的协议字段是2，表明使用网际组管理协议IGMP。**
* **多播地址只能用于目的地址，而不能用于源地址。**对多播数据报不产生ICMP差错报文，因此，若在PING命令后面键入多播地址，将永远不会收到响应。
* IP多播可以分为两种。一种是只在本局域网进行硬件多播，另一种则是在互联网的范围进行多播。**在互联网上进行多播的最后阶段，还是要把多播数据报在局域网上用硬件多播交付多播组成员。**
* **在局域网上进行硬件多播**：
  1. 由于多播IP地址与以太网硬件地址的映射关系不是唯一的，因此收到多播数据报的主机，还要再IP层利用软件进行过滤，把不是本主机接收的数据报丢弃。
* **网际组管理协议IGMP和多播路由选择协议**：
  1. IGMP并非在互联网范围内对所有多播组成员进行管理的协议。IGMP不知道IP多播组包含的成员数，也不知道这些成员分布在哪些网络上。**IGMP协议让连接在本地局域网上的多播路由器知道本局域网上是否有主机（准确地所是主机上的某个进程）参加或退出了某个多播组。**
  2. **多播路由选择协议：**
     * 多播转发必须动态地适应多播组成员的变化，尽管此时网络拓扑并未发生变化。单播路由选择通常是在网络拓扑发生变化时才需要更新路由。
     * **多播路由器在转发多播数据报时，不能仅仅根据多播数据报中的目的地址**，还要考虑这个多播数据报从什么地方来和要到什么地方去。
     * **多播数据报可以由没有加入多播组的主机发出，也可以通过没有组成员接入的网络。**
     * **多播路由选择实际上就是要找出以源主机为根节点的多播转发树。**对不同的多播组对应于不同的多播转发树。同一个多播组，对不同的源点也会有不同的多播转发树。
     * **多播路由选择协议的方法**：
       1. **洪泛与剪除**：先检查数据报是否是从源点经最短路径传送来的。若是，就向所有其他方向转发刚才收到的多播数据报。否则就丢弃而不转发。如果本路由器有好几个相邻路由器都处在到源点的最短路径上，那么只能选择一条最短路径（IP地址最小）。**如果在多播转发树上的某个路由器发现它的下游树枝已没有该多播组的成员，就应把它和下游的树枝一起剪除。**
       2. **隧道技术**:对多播数据报进行再次封装，即再加上普通数据报的首部，使之成为**单播**数据报（IP-in-IP）。
       3. **基于核心的发现技术**：对每一个多播组G指定一个**核心路由器**，给出它的IP单播地址，创建出对应于多播组G的转发树。**途径的每一个路由器都要检查其内容，当数据报到达某一个路由器时就处理这个数据报。**如果发出的是一个多播数据报，就向多播组G的成员转发这个多播数据报。如果发出的是请求加入多播组G的数据报，就把这个信息加入到它的路由中，并用隧道技术转发每一个多播数据报的副本。
  3. **网际组管理协议IGMP**：
     * 当某台主机加入新的多播组时，该主机应向多播组的多播地址发送一个IGMP报文，声明自己要成为该组成员。本地的多播路由器收到IGMP报文后，还要利用多播路由选择协议把这种组成员关系转发给互联网上的其他多播路由器。
     * 组成员关系是动态的。本地多播路由器要周期性地探询本地局域网上的主机，以便知道这些主机是否还继续是组的成员。主要有一台主机对某个组相应，那么多播路由器就认为这个组是活跃的。
     * 在主机和多播路由器之间的所有通信都是使用IP多播。只要有可能，携带IGMP报文的数据报都是用硬件多播来传送。因此**在支持硬件多播的网络上，没有参加IP多播的主机不会收到IGMP报文。**
     * 同一个组内的每一台主机都要监听响应，只要有本组的其他主机先发送了响应，自己就可以不再发送响应了。**多播路由器并不需要保留组成员关系的准确记录，因为向局域网上的组成员转发数据报是使用硬件多播。多播路由器只需要知道网络上是否至少还有一台主机是本组成员即可。对询问报文，每一个组只需要一台主机发送响应。**
     * 如果一台主机上有多个进程都加入了某个多播组，**那么这台主机对发给这个多播组的每个多播数据报只接收一个副本，然后给主机的每个进程发送一个本地复制的副本。**
     * **多播数据报的发送者和接收者都不知道（也无法找出）一个多播组的成员有多少，以及这些成员是哪些主机。**

## 4.8 虚拟专用网VPN和网络地址转换NAT

* RFC 1918指明了一些**专用地址**。这些地址只能用于一个机构的内部通信，而不能用于和互联网上的主机通信。**互连网上的所有路由器，对目的地址是专用地址的数据报一律不进行转发。**
  1. 10.0.0.0到10.255.255.255（24位块）
  2. 172.16.0.0到172.31.255.255（20位块）
  3. 192.168.0.0到192.168.255.255（16位块）
* 采用专用IP地址的互联网称为**专用互联网**或**本地互联网**。专用IP地址也叫作可重用地址。

### 4.8.1 网络地址转换NAT

* 场景：专用网内部的一些主机本来已经分配到了本地IP地址，但现在又想和互联网上的主机通信。
* **网络地址转换**：在NAT路由器上将本地地址转换成全球IP地址，NAT路由器上至少有一个有效地外部全球IP地址。
* NAT路由器把IP数据报的源IP地址，转换成新的源IP地址，然后转发出去。当NAT路由器收到互联网上的主机IP发来的IP数据报时，还要进行一次IP转换，从而发送给本地主机。
* 当NAT路由器具有n个全球IP地址时，专用网内最多可以同时有n台主机接入到互联网。这样就可以使专用网内较多数量的主机，轮流使用NAT路由器有限数量的全球IP地址。
* 通过NAT路由器的通信必须由专用网内的主机发起。专用网内部的主机不能充当服务器用，因为互联网上的客户无法请求专用网内的服务器。
* **为了更加有效利用NAT路由器上的全球IP地址，现在常用的NAT转换表把运输层的端口号也用上了。这样就可以使多个拥有本地地址的主机，共用一个NAT路由器上的全球IP地址，因而可以同时和互联网上的不同主机进行通信。**
* 使用端口号的NAT也叫做**网络地址和端口号转换NAPT**，而不使用端口号的NAT就叫传统的NAT。
