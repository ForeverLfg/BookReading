

# 《图解TCP/IP》

# 一、网络基础知识

## 1.OSI模型

![image-20210711231605561](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210711231605561.png)

* 发送端和接收端的处理流程正好**相反**，就像收发快递一样。发送方执行的是打包的操作，接收方则执行拆包操作。

* 数据每向下传输一层，就加一层标签；同样的，没向上传递一层，就拆一层标签。

## 2.传输方式的分类

### 2.1 面向有连接型和面向无连接型

  ![image-20210711235046362](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210711235046362.png)

###     2.2 电路交换与分组交换

![image-20210712001203066](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210712001203066.png)

![image-20210712001441804](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210712001441804.png)

## 3. 地址

* 网络通信中，每一层协议所使用的地址不尽相同。

* MAC地址和IP地址在标识一个通信主体时虽然都具有唯一性，但是他们当中只有**IP地址**具有唯一性。

* **地址转发表**：MAC寻址所参考的表；**路由控制表**：IP寻址参考的表。

  ![image-20210712224202415](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210712224202415.png)

## 4.网络的构成要素

![image-20210712230140999](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210712230140999.png)

* 从严格意义上讲，各种传输媒介中信号的流动速度是恒定的。
* 传输速率高并不是指单位数据流动的速度有多快，而是指单位时间内传输的数据量有多少。
* 低速数据链路就如同车道较少无法让很多车同时通过；高速速率相当于有多个车道，一次允许更多车辆行驶的道路。
* 主机之间实际的额传输速率被称做吞吐量，单位为bps(每秒比特数)；吞吐量不仅衡量贷款，也衡量主机的CPU处理能力、网络的拥堵程度、报文中数据字段的占有份额。



### 4.1 中继器--物理层

![image-20210712232719067](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210712232719067.png)

* 对减弱的信号进行放大和发送
* 通过物理层的连接延长网络
* 即使在数据链路层出现某些错误，中继器仍然转发数据
* 中继器无法改变传输速率



### 4.2 网桥（2层交换机）——数据链路层

* 在OSI模型的第2层（数据链路层），连接两个网络；
* 将数据帧临时存储于内存，再重新生成信号作为一个全新的帧转发给相连的另一个网段；
* 数据帧中有一位叫FCS，用以校验数据是否正确送达目的地；
* 根据MAC地址进行处理。

![image-20210712234345237](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210712234345237.png)

![image-20210712234940360](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210712234940360.png)

* 以太网等网络中经常使用的交换集线器（Hub）,现在也属于网桥的一种；交换集线器中连接电缆的每个端口都能提供类似网桥的功能。

  

## 4.3 路由器（3层交换机）--网络层

* **网桥根据物理地址（MAC地址）进行处理**，路由器则根据IP地址进行处理;
* 路由器可以连接两个不同的网络；
* 路由器还分担网络负荷，甚至有的路由器还具备一定的网络安全功能。

### 4.4 4-7层交换机

* 处理OSI模型中从传输层到应用层的数据。
* 举例：负载均衡器（多台服务器来分担访问压力）、带宽控制（优先处理及时性要求较高的通信请求，放缓处理及时性不高的要求）、广域网加速器、特殊应用访问加速和防火墙

## 4.5 网关

![img](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fwww.elecfans.com%2Fbaike%2FUploadPic%2F2010-4%2F20104315148597.jpg&refer=http%3A%2F%2Fwww.elecfans.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1628724847&t=0ed7170b53839305cf55d13849c59803)

* **协议的转换**和**数据的转发**；

* 在两个不能进行直接通信的协议之间进行翻译，最终实现两者之间的通信；

* 手机和互联网设置了一层网关；

  **网关举例**：

  代理服务器：为了控制流量以及处于安全的考虑，这种叫做应用网关。

  防火墙：针对不同应用提高了安全性。
  
  ## 4.6 现代网络实态
  
  * 核心网：计算机网络的核心
  * 接入层（汇聚层）：计算机网络中连接“边缘网络”的部分
  * 移动通信：基站收集的通信请求被汇集到控制中心（“边缘网络”），之后会再被接入到互联通信控制中心
  * CSFB：让语音呼叫部分仅在收集通信网络中传输
  * 边缘网络：网络中相应于高速公路出入口的部分。
  * 数据中心：对于那些人气较高的作品，其访问量可能会达到每天几十万次。面对这么高的并发访问量，托管主机服务，为了减少访问延迟，会集合多个存储于一起，通过连接高速网络，以期提高响应速度。有些大型的数据中心甚至直接连接“主干网”。
  * **虚拟化技术**：当一个网站需要调整运营所使用的资源时，并不增减服务器、存储设备、网络等实际的物理设备，而是利用软件将这些物理设备虚拟化，在有必要增减资源的时候，通过软件按量增减的一种机制。可以实现按需分配、按比例分配，对外提供可靠的服务。
  * 云：根据使用者的情况动态调整必要资源的机制。
  
  ![image-20210713140515470](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210713140515470.png)

# 二、TCP/IP基础知识

* TCP和IP是互联网的众多通信协议中最为著名的。

![image-20210713214859777](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210713214859777.png)

## 1.TCP/IP的历史进程

![image-20210713221111670](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210713221111670.png)

## 2.TCP/IP的标准化

![image-20210713221658280](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210713221658280.png)

* TCP/IP协议指的是利用IP进行通信时所必须用到的协议群的统称。



## 3.TCP/IP标准化的精髓

* 开放性+实用性

* “TCP/IP”简直就是先开发程序，后写规格标准

* RFC（Request For Comment）：在互联网上公布。不仅激励了协议规范内容，还包含了协议的实现和运用的相关信息。

* RFC文档通过编号组织每个协议的标准化请求，有人提出每当对RFC进行修改时都要产生新的RFC编号太麻烦，于是人们采用STD方式管理。STD记录哪个编号指定哪个协议。

* 主机和路由器处理ICMP时所涉及的要求细节也写入了RFC，分别为RFC1122和RFC1812。

  

## 4.TCP/IP的标准化流程

* TCP/IP的标准化过程与一般的标准化过程不同。它不是由标准化组织指定为标准之后才开始投入应用，而是到其成为标准的那一刻为止，已经被较为充分地试验并得到较广的普及。

![image-20210713224526343](C:\Users\Forever\AppData\Roaming\Typora\typora-user-images\image-20210713224526343.png)



![image-20210721214328722](C:\Users\mi'ku\AppData\Roaming\Typora\typora-user-images\image-20210721214328722.png)



![分层中包的结构](E:\Github学习\BookReading\Pictures\分层中包的结构.jpg)

* 每个分层中，都会对所发送的数据附加一个首部；

* 网络中传输的数据包由两部分组成：一部分是协议所要用到的首部，另一部分是上层传过来的数据；

* 看到包首部，就如同看到协议的规范；

  

  **发送数据包**

  - 应用层：点击“发送”那一刻就可以开始TCP/IP通信了
  
  - TCP提供将应用层发来的数据顺利发送至对端
  
  - IP将TCP传过来的TCP首部和TCP数据合起来当做自己的数据，并加上自己的IP首部；IP包生成后，参考路由控制表决定接受此IP包的路由或主机
  
  - 如果尚不知接收端的MAC地址，可以利用ARP查找
  
  - 从IP传过来的IP包，对于以太网驱动来说就是数据。加上以太网首部并进行发送处理
  
  - 以太网首部中包含接收端MAC地址、发送端MAC地址
  
    
  
  
    - 包流动时，从前往后依次被附加了**以太网首部**，**IP包首部**，**TCP（UDP）包首部**以及**应用自己的包首部和数据**。而包的最后则追加了以太网包尾。
    - 每个包首部中至少都会包含两个信息：一个是发送端和接收端地址，另一个时上一层的协议类型。
    - 经过每个协议分层时，都必须由识别包发送端和接收端的信息。以太网会用MAC地址，IP会用IP地址，而TCP(UDP)会用端口号。
    - 每个分层的包首部中还包含一个识别位，用来标识上一层协议的种类信息。



**接收数据包**

* 网络接口（以太网驱动）处理：如果不是IP而是其他诸如ARP包，则将数据传给ARP处理
* IP模块处理：分发给TCP和UDP，需要借助路由控制表
* TCP模块处理：TCP会计算校验和，判断数据时候损坏，接收端会发送一个“确认回执”。如果这个回执一直没有返回给发送端，则发送端会一直反复发送。
* 应用程序的处理：邮件会被保存到本机的硬盘上。





**SNS中的通信实例**：由于移动电话、智能手机、平板电脑等在进行分组数据的通信时，在它们装入电池开机的那一刻，已经由运营商设定了具体的IP地址。**启动电话中的应用程序时，会连接制定的服务器，经过用户名、密码验证后服务器上累计的信息就会发送到手机终端上。**

# 三. 数据链路

## 3.1 数据链路相关技术



**MAC地址**（00:80:4A:12:21:01）：

* MAC地址长48比特。在使用网卡（NIC）的情况下，MAC地址一般会被烧到ROM中。
  - 第1位：单播地址（0）/ 多播地址（1）
  - 第2位：全局地址（0）/ 本地地址（1）
  - 第3~24位：由IEEE管理并保证各厂家之间不重复
  - 第25-48位：由厂商管理并保证产品之间不重复
  
* IEEE802.3制定的MAC地址规范时没有限定数据链路的类型，即不论哪种数据链路的网络（以太网、FDDI、ATM、无线LAN、蓝牙等），都不会有相同的MAC地址出现。例外：虚拟机MAC地址由软件分配

* 厂商识别码：有一种设备叫网络分析器，可以分析出局域网中的包是哪个厂商的网卡发出的。

* 共享介质型网络：多个设备共享一个通信介质，设备之间使用同一个载波信道进行发送和接收，分为**争用方式**和**令牌传递方式**。

* 争用方式：网络中的各个站采用先到先得的方式占用信道传送数据，也叫载波监听多路访问（CSMA）；

* 令牌传递方式：沿着令牌环发送一种叫做“令牌”的特殊报文，只有获得令牌的站才能传送数据。

* **非共享介质网络** 
  - 网络中的每个站直连交换机，由交换机负责转发数据。缺点是一旦交换机发生故障，与之相连的所有计算机之间都将无法通信。
  - **半双工**：只发送或只接收，若两端同时说话，是听不见对方说话的。
  - **全双工**：允许在同一时间既可以发送数据也可以接收数

  

  ### 3.2 以太网帧格式

  * 以太网前端有一个叫做前导码的部分，由0,1数字交替组合而成，表示一个以太网帧的开始，也是对端网卡能够确保与其同步的标志。
  * 以太网帧本体的前端是以太网的首部，它总共占14个字节。分别是6个字节的目标MAC地址、6个字节的源MAC地址以及2个字节的上层协议类型。
  * 紧随帧头后面的是数据。一个数据帧所能容纳的最大数据范围位46~1500个字节。
  * 帧尾是一个叫做FCS的四个字节。
  * 在目标MAC地址中存放了目标工作站得物理地址。源MAC地址中则存放了构造以太网帧的发送端工作站物理地址。
  * **类型**通常跟数据一起传送，它包含用以标识协议类型的编号，即表明以太网的再上一层网络协议的类型。
  * 帧尾最后出现的是FCS，用以检查帧是否有所损坏。

  

  ### 3.3 无线通信

  * IEEE 802委员会制定了无线PAN、无线LAN、无线MAN以及无线RAN等无线标准。无线LAN的最典型代表就是手机通信。

  ### 3.4 PPP

  * PPP是指点对点，主要包含两个协议：一个是不依赖上层的LCP协议，另一个时依赖上层的NCP协议。如果上层是IP，此时的NCP也叫作IPCP。
  * LCP主要负责建立和断开连接、设置最大接收单元、设置验证协议以及设置是否进行通信质量的监控。
  * IPCP则负责IP地址设置以及是否进行TCP/IP首部压缩等设置。
  * 通过PPP连接时，通常需要验证用户名和密码，并且对通信两端进行双向验证。其验证协议有两种：PAP和CHAP。
    * PAP是PPP连接建立时，通过两次握手进行用户名和密码验证。其中密码以明文方式传输。因此一般用于安全要求并不很高的环境，否则会有窃听或盗用连接的危险。
    * CHAP是使用一次性密码OTP，可以有效防止窃听。此外，在建立连接后还可以进行定期的密码交换，用来验证对端是否中途被替换。

  ##  四、IP协议

  ### 4.1 IP即网际协议

  * 数据链路层的主要作用是在互联同一种数据链路的节点之间进行包传递。而一旦跨越多种数据链路，就需要借助网络层。网络层可以跨越不同的数据链路，即使是在不同的数据链路上也能实现两端节点之间的数据包传输。
  * 数据链路层提供两个直连设备之间的通信功能。与之相比，作为网络层的IP则负责在没有直连的两个网络之间进行通信传输。
  * IP大致分为三大作用模块：**IP寻址**、**路由**以及**IP分包与组包**。
  * 多跳路由指的是路由器或主机在转发IP数据包时只指定下一个路由器或主机，而不是将到最终目标地址为止的所有通路全部指定出来。
  * 为了将数据包发给目标主机，所有主机都维护着一张**路由控制表**。该表记录IP数据在下一步应该发给哪个路由器。IP包将根据这个路由表在各个数据链路上传输。

  ### 4.2 IP地址的基础知识

  - IP地址的两个组成部分：**网络标识**和**主机标识**。
    * A类地址：首位以“0” 开头的地址。从第1位到第8位是网络标识；后24位相当于主机标识。
    * B类地址：前两位以“10”开头的地址。从第1位到第16位是网络标识；后16位是主机标识。
    * C类地址：前三位以“110”开头的地址。从第1位到第24位是网络标识；后8位是主机标识、
    * D类地址：前四位以“1110”开头的地址。从第1位到第32位为网络标识；没有主机标识。
  - 主机地址不可以全部为0，也不可以全部为1.**全部为0表示对应的网络地址或IP地址不可获知；全部为1表示广播地址**。
  - 广播地址分为：**本地广播**和**直接广播**。
  - IP多播：在人们使用多播功能之前，一直采用广播的方式。那时广播将数据发给所有终端主机，再由这些主机IP之上的一层去判断是否有必要接收数据。是则接收，否则丢弃，这样造成网络上很多不必要的流量。因此，**多播这种既可以穿透路由器，又可以实现只给那些必要的组发送数据包的技术就成为必选之路**。
  - IP多播使用D类地址，前四位是“1110”，剩下的28位为多播的组编号。
  - 对于多播，所有的主机必须属于224.0.0.1的组，所有的路由器必须属于224.0.0.2的组。
  - **利用IP多播实现通信，除了地址外还需要IGMP等协议的支持。**
  - 由于网络标识相同的计算机必须属于同一个链路，因此直接使用A类或B类地址确实有些浪费。随着互联网的覆盖范围逐渐增大，网络地址会越来越不够用。
  - 人们通过“子网掩码”细分出比A类、B类、C类和D类更加细分的网络。
  - 人们之后放弃IP地址的分类，采用任意长度分割IP地址的网络标识和主机标识，叫做CIDR。
  - 之后人们提出组织内要使用可变长度、高效的IP地址分配方式，随之也就产生了一种可以随机修改组织内各个部门的子网掩码长度的机制----**VLSM**。
  - 如果一直按照采用唯一IP地址的方案，会有IP地址耗尽的风险，于是出现一种新技术：不要求每一台主机或路由器分配一个固定的IP地址，而是在必要的时候只为一定数量的设备分配一个唯一IP地址。于是出现了私有网络的IP地址。而与支对应的就是公有IP地址。
  - 现在很多公司和学校都采用每个终端设置私有IP，而在路由器或必要的服务器上设置全局IP地址的方法。在不同的域里面出现相同的私有IP地址不会影响使用。**私有IP地址有它对应的范围。**
  - **由此，私有IP地址结合NAT技术已成为现在解决IP地址分配问题的主流方法**。
  - 一般只有在需要固定IP的情况下才会申请全局IP地址。现在普遍采用的方式是通过少数设置全局IP地址的代理服务器，结合NAT的设置进行互联网通信。这是IP地址个数就不限于LAN中主机个数而是由代理服务器和NAT个数决定。
  - 网络技术人员可以通过检查ICMP包、利用traceroute等明年定位发生异常的设备或线路最近的IP地址。



### 4.3 IP分割处理与再构成处理

* 每种数据链路的最大传输单元（MTU）不同，可承载的MTU就不同。但是IP属于数据链路上一层，必须不受限于不同数据链路的MTU大小。
* 经过路由器分片之后的IP数据报在被重组的时候，只能由目标主机进行。路由器做分片但是不会进行重组。在目标主机重组分片了的IP数据报成为了现行的规范。
* IP首部中的“片偏移”字段表示分片之后每个分片在用户数据中的相对位置和该分片之后是否还有后续其他分片。
* 分片机制的不足在于路由器的处理负荷加重，随着人们对网络安全的要求提高，是不希望由路由器进行IP数据包的分片处理的。为了应对这个问题。产生了一种新的技术“路径MTU发现”。
* 路径MTU是指从发送端主机到接收端主机之间不需要分片时最大MTU的大小。即路径中存在的所有数据链路中最小的MTU。
* 路径MTU发现从发送主机按照路径MTU的大小将数据报分片后进行发送。进行路径MTU发现，就可以避免在中途的路由器上进行分片处理，也可以在TCP中发送更大的包。现在，很多操作系统都已经实现了路径MTU发现的功能。
* 路径MTU发现的工作原理如下
  * 首先在发送端主机发送IP数据宝时，其首部的分片禁止标志位设置为1。根据这个标志位，途中的路由器即使遇到需要分片才能处理的大包，也不会去分片，而是将包丢弃。随后，通过一个ICMP的不可达消息将数据链路上MTU的值给发送主机。
  * 下一次，从发送给同一个目标主机的IP数据报获得ICMP所通知的MTU值以后，将它设置为当前MTU。发送主机根据这个MTU对数据报进行分片处理。
  * 如此反复，直到数据报被发送到目标主机为止没有再收到任何ICMP，就认为最后一次ICMP所通知的MTU即时一个合适的MTU值。那么，当MTU的值较多时，最少可以缓存约10分钟。在这10分钟内使用求得的MTU，但过了这10分钟以后则重新根据链路上的MTU做一次路径MTU发现。
  * UDP没有重发机制，应用在发送下一个消息时会被分片。具体来说，就是指UDP层传过来的“UDP首部+UDP数据”在IP层被分片。对于IP，它并不区分UDP首部和应用的数据。
  * 
* 在TCP的情况下，根据路径MTU的大小计算出最大段长度（MSS），然后再根据这些信息进行数据报的发送。**TCP负责将数据分成IP层不会再被分片的粒度以后传给IP层，IP层不再做分片处理**。因此，在TCP中如果采用路径MTU发现，IP层则不会再进行分片处理。

### 4.4 IPV6

1. IPv4的地址长度位4个8位字节，即32比特；IPv6的地址长度则是原来的4倍，即128比特，一般写成8个16位字节、
2. IPv6具有一些在IPv4中难以实现的功能：
   * IP地址的扩大与路由控制表的聚合。
   * 性能提升：简化首部结构，减轻路由器负荷，路由器不再做分片处理。
   * 支持即插即用功能，没有DHCP服务器也能实现自动分配IP地址。
   * 采用认证与加密功能：应对伪造IP地址的网络安全功能以及防止线路窃听的功能。
   * 多播和Mobile IP成为扩展功能。
3. IPv6的分片处理只在作为起点的发送端主机上进行，路由器不参与分片。这是为了减少路由器的负荷，提高网速。



### 4.7 IPv4的首部

通过IP进行通信时，需要在数据的前面加入IP首部信息。IP首部中包含着用于IP协议进行发包控制时所有的必要信息。

<center> <font face="黑体" size=6 >IPv4的首部</font> </center>

| 首部标签        | 长度     | 描述                                                         |
| --------------- | -------- | ------------------------------------------------------------ |
| 版本（Version） | 4比特    | 标识IP首部的版本号                                           |
| 首部长度        | 4比特    | 标识IP首部的大小                                             |
| 区分服务        | 8比特    | 表明服务质量，通常由应用指定                                 |
| 总长度          | 16比特   | IP首部与数据部分结合起来的总字节数。IP报的最大长度为2^16=65535字节 |
| 标识            | 16比特   | 用于分片重组，同一个分片的标识值相同，每发送一个IP包，她得值逐渐递增。 |
| 标志            | 3比特    | 表示包被分片的相关信息                                       |
| 片偏移          | 13比特   | 标识被分片的每一个分段相对于原始数据的位置                   |
| 生存时间（TTL） | 8比特    | 最初表示以秒为单位记录当前包在网络上的生存时间。实际是指可以中转多少个路由器。 |
| 协议            | 8比特    | IP包传输层的上层协议编号。                                   |
| 首部检验和      | 16比特   | 只校验数据报的首部，不校验数据部分。用来确保IP数据报不会被破坏。 |
| 原地址          | 32比特   | 发送端IP地址                                                 |
| 目标地址        | 32比特   | 接收端地址                                                   |
| 可选项          | 长度可变 | 通常只在进行实验或诊断时使用，包含：安全级别、原路径、路径记录和时间戳 |
| 填充            | 长度可变 | 在有可选项的时候，填充0，使得首部长度时32比特的倍数          |
| 数据            | 长度可变 | 将IP上层协议的首部也作为数据进行处理                         |



### 4.8 IPv6的首部

IPv6中为了减轻路由器负担，省略了首部校验和字段。因此路由器不再需要计算校验和，从而也提高了包的转发效率。

| 首部标签     | 长度         | 简要描述                                                     |
| ------------ | ------------ | ------------------------------------------------------------ |
| 版本         | 4比特        | IPv6的版本号为6，因此在这个字段上的值为6                     |
| 通信量类     | 8比特        | 由于TOS在IPv4中几乎没有什么建树，未能成为卓有成效的技术，本来计划在IPv6中删掉这个字段。不过，出于今后研究的考虑还是保留了该字段。 |
| 流标号       | 20比特       | 准备用于服务质量控制。使用这个字段提供怎样的服务已经成为未来研究的课题。 |
| 有效载荷长度 | 包的数据部分 | IPv4的TL是指包括首部在内的所有长度。然而IPv6中的这个有效载荷长度不包括首部，只表示数据部分的长度。由于IPv6的可选项是指连接IPv6首部的数据，因此当有可选项时，此处包含可选项数据的所有长度就是有效载荷长度。 |
| 下一个首部   | 8比特        | 相当于IPv4中的协议字段。通常表示IP的上一层协议是TCP或UDP。不过在有IPv6扩展首部的情况下，该字段表示后面第一个扩展首部的协议类型。 |
| 跳数限制     | 8比特        | 与IPv4中的TTL意思相同。数据每经过一次路由器就减1，减到0则丢地数据。 |
| 源地址       | 128比特      | 发送端IP地址                                                 |
| 目标地址     | 128比特      | 接收端IP地址                                                 |



IPv6的首部长度固定，无法将**可选项**加入其中。取而代之的是通过**扩展首部**对功能进行了有效扩展。扩展首部通常介于IPv6首部与TCP/UDP首部的中间。在IPv4中可选项长度固定为40字节，但是在IPv6中没有这样的限制。也就是说，IPv6的扩展首部可以是任意长度。扩展首部当中还可以包含扩展首部协议以及下一个扩展首部字段。

IPv6首部中没有标识以及标志字段，在需要对I跑数据报进行分片时，可以使用扩展首部。



## 五、IP协议相关技术

仅有IP是无法实现通信的，必须还有能够解析主机名称和MAC地址的功能，以及数据报在发送过程中异常处理的功能。

### 5.1 DNS

1. 直接使用IP地址会有很多不便之处，因为IP地址由一串数据序列组成，并不好记。
2. TCP/IP世界中一开始就已经有了一个叫做**主机识别码**的东西，为每台计算机赋以唯一的主机名，在进行网络通信时可以直接使用主机名称而无需输入一大长串的IP地址。系统必须自动将主机名转换为具体的IP地址。为了实现这样的功能，主机往往会利用一个叫做hosts的数据。
3. 起初由互联网信息中心(SRI-NIC)整体管理一份hosts文件。如果新增一台计算机接入到ARPANET网或已有的计算机要进行IP变更，中心的这个hosts文件就得更新，而其他的计算机则不得不定期下载更新的hosts文件才能正常使用网络。
4. 这种集中管理主机名和IP地址的登录、变更处理的可行性逐渐降低。在这个背景之下，产生了一个可以有效管理主机名和IP地址之间对应管理的系统：DNS系统。
5. 在DNS应用中，当用户输入主机名（域名）时，DNS会自动检索哪个注册了主机名和IP地址的数据库，并迅速定位对应的IP地址。
6. 域名服务器：管理域名的主机和相应的软件，可以管理所在分层的域的相关信息。其所管理的分层叫做ZONE，每层都设有一个域名服务器。
7. **解析器**：进行DNS查询的主机和软件叫做DNS解析器。用户所使用的工作站或个人电脑都属于解析器。
8. 解析器为了查询IP地址，向域名服务器进行查询处理。接收这个查询请求的域名服务器首先会在自己的数据库进行查找。如果该域名服务器所对用的IP地址查询到就返回。如果没有，则域名服务器会再向上一层**根域名**服务器进行查询处理。
9. DNS如同互联网中的分布式数据库，主机名与IP地址的对应信息叫做A记录，反之从IP地址检索主机名称的信息叫做PTR。

### 5.2 ARP

在进行实际通信时，必须了解每个IP地址所对应的MAC地址。

1. ARP是一种解决地址问题的协议。以目标IP地址为线索，用来定位下一个应该接收数据分包的网络设备对应的MAC地址。如果目标主机不在同一个链路上时，可以通过ARP查找下一跳路由器的MAC地址。
2. ARP只适用于IPv4，IPv6中可以用IPv6替代ARP发送邻居探索消息。

**ARP的工作机制：ARP请求于ARP相应**

1. 主机A为了获得主机B的MAC地址，起初要通过广播发送一个ARP请求包。这个包中包含了想要了解其MAC地址的主句IP地址。
2. 由于广播的包可以被同一个链路上所有的主机或路由器接收，因此ARP的请求包也就会被这同一个链路上所有的主机和路由器进行解析。
3. 如果ARP请求包中的目标IP地址与自己的IP地址一致，那么这个节点就将自己的MAC地址塞入ARP相应包返回给主机A。

* 如果每发送一个IP数据报都要进行一次ARP请求以此确定MAC地址，那将会造成不必要的网络流量。因此，通常的做法是把获取到的MAC地址缓存一段时间。每执行一次ARP，其对应的缓存内容都会被删除。

**IP地址和MAC地址缺一不可？**

1. 发送端主机A即使知道了接收端主机B的MAC地址，由于路由器会隔断两个网络，还是无法实现直接从主机A发送数据给主机B。
2. 此时，主机A必须得先将数据报发送给路由器C的MAC地址。
3. **虽然IP地址直至到达目标主机时都没有发生变化，但是数据链路的目标地址却根据每个链路的不同而发生着变化。**
4. 此外，假定MAC地址就用广播地址，那么其他路由器D/F/G等也会收到该广播信息。于是其他路由器又将该消息转发给路由器C，导致数据包被重复发送多次。
5. 在以太网上发送IP包时，“下次要经由哪个路由器发送数据报”这一信息非常重要。而这里的“下一个路由器”就是对应的MAC地址。
6. 最后，如果不使用IP地址，仅凭一个MAC地址，人们是无法知道这台机器所处的位置的。而且如果全世界的设备都使用MAC地址相连，那么网桥在习得之前就得向全世界发送包。可想而知那将会造成多大的网络流量。而且由于没有任何集约机制，网桥就不得不维护一张巨大的表格来维护所学到的所有MAC。

### 5.3 RARP

将ARP反过来，从MAC地址定位IP地址的一种协议。例如将打印机服务器等小型嵌入式设备接入到网络时就经常会用得到。

* RARP服务器：当设备接入时，设备会发送一条消息给RARP服务器：“我的MAC地址时XXX，我的IP地址是什么？”的请求消息。RARP服务器会返回对应的IP地址给设备。
* **代理ARP**

通常ARP包会被路由器隔离，但是采用代理ARP的路由器可以将ARP请求转发给临近的网段。由此，两个以上网段的节点之间可以像在同一个网段中进行通信。

* 在目前的TCP/IP网络中，一般情况下用路由器连接多个网络时，会在每个网段上定义各自的子网，从而进行路由控制。然而，对于那些不支持设定子网掩码的老设备来说，不使用代理ARP，有时就五大更好地使用网络。

### 5.4 ICMP

为了确保网络能够按照预期正常工作，一旦遇到什么问题需要立即制止问题蔓延。ICMP正是提供这类功能的协议。

1. ICMP的主要功能包括：确认IP包是否成功送达目标地址，通知在发送过程中IP包被废弃的具体原因，改善网络设置等。

2. 网络的设置可以包括很多内容，网线连好后涉及IP地址或子网掩码的设置、路由表的设置、DNS服务器的设置、邮件服务器的设置以及代理服务器的设置等。ICMP只负责其中与IP相关的设置。

3. 在ICMP中，包以明文的形式像TCP/UDP一样通过IP进行传输。然而，ICMP所承担的功能并非传输层的补充，而应该将其看做IP的一部分。

4. ICMO的消息大致可以分为两类：一类是通知出错原因的错误消息；另一类是用于诊断的查询消息。

   | ICMP消息类型       | 简要描述                                                     |
   | ------------------ | ------------------------------------------------------------ |
   | ICMP目标不可达消息 | IP路由器无法将IP数据包发送给目标地址时，会给发送端主机返回一个目标不可达的ICMP消息，并在这个消息中显示不可达的原因。 |
   | ICMP重定向消息     | 如果路由器发现发送端主机选择了一条次有的路径，那么它会返回一个ICMP重定向的消息给发送端主机。在这个消息中包含了最适合的路由信息和源数据。 |
   | ICMP超时消息       | IP包中有一个字段叫做TTL，它的值随着没进过一次路由器就会减1。设置IO包生存周期的主要目的，是为了在路由控制遇到问题发生循环状况时，避免IP包无休止地在网络上被转发。 |
   | ICMP回送消息       | 主机和路由器之间，判断数据包有没有发送成功，可以向对端主句发送回送请求消息，也可以接收对端主机发回来的回送应答消息。 |
   | ICMP原点抑制消息   | 当路由器在低速线路发送消息时，为了避免遇到网络拥堵的情况，可以向IP包的源地址发送一个ICMP原点抑制消息，避免发送队列的残存变为零而无法发送出去。 |
   | ICMP路由探索消息   | 用于发现与自己相连网络中的路由器。                           |
   | ICMP地址掩码消息   | 用于主机或路由器想要了解子网掩码的情况。                     |

   * ICMPv6:

   1. 在IPv4时期，即使没有ICMP，仍然可以实现IP通信。然而，在IPv6中，ICMP的作用被扩大，如果没有ICMPv6，IPv6就无法进行正常通信。
   2. 在IPv6中，从IP地址定位MAC地址的协议从ARP转为ICMP的邻居探索消息。这种邻居探索消息融合了IPv4的ARP、ICMP重定向以及ICMP路由器选择消息等功能与一体，甚至还提供了自动设置IP地址的功能。
   3. ICMPv6中将ICMP消息大致分为两类：一类是错误消息；另一类是信息消息。
   4. 邻居探索：用于查询IPv6的地址与MAC地址的对应关系，并由邻居宣告消息得知MAC地址。**邻居请求消息利用IPv6的多播地址**实现传输。
      1. 由于IPv6实现了即插即用的功能，所以在没有DHCP服务器的环境下也能实现IP地址的自动获取。如果在一个没有路由器的网络，就使用MAC地址作为链路本地单播地址。而在一个有路由器的网络环境中，可以从路由器获得IPv6地址的前面部分，后面部分则由MAC地址进行设置。

   

   ### 5.5 DHCP

   逐一为每一台主机设置IP地址会是一件非常繁琐的事情，于是为了实现自动设置IP地址、统一管理IP地址分配，就产生了DHCP协议。DHCP不仅在IPv4中可以用，在IPv6中一样适用。

   1. 在使用DHCP之前，需要先假设一台DHCP服务器，将DHCP所要分配的IP地址设置到服务器上。此外，还需要将相应的子网掩码、路由控制信息以及DNS服务器的地址等设置到服务器上。

   2. DHCP分配IP地址有两种方法。一种是由DHCP服务器在特定的IP地址中自动选出一个进行分配。另一种方法是针对MAC地址分配一个固定的IP地址。

   3. 为了检查所要分配的IP地址以及已经分配了的IP地址是否可用，DHCP服务器或DHCP客户端必须具备以下功能：

      * DHCP服务器：在分配IP地址前发送ICMP回送请求包，确认没有返回应答。
      * DHCP客户端：针对从DHCP服务端获取的IP地址发送ARP请求包，确认没有返回应答。

   4. 家庭网络中大多只有一个以太网网段，连接的主机不会太多。只要有一台DHCP服务器足够，大多数情况由路由器充当了这个角色。

   5. 而在大规模组织中，若要针对每个网段都设置DHCP服务器将会是一个庞大的工程，并且其变更维护工作也是一项巨大的工程。在这一类网络中，往往需要DHCP统一管理，具体方法是**使用DHCP中继代理**。有了DHCP中继代理，对不同网段的IP地址进行分配也可以由一个DHCP服务器统一进行管理和维护。

   6. 架设一个DHCP服务器，在每一个网段内设置一个DHCP中继代理，在DHCP服务器上为每个网段注册IP地址的范围：

      * 1） DHCP客户端向DHCP中继代理发送DHCP请求包；
      * 2）DHCP中继代理在收到这个广播包以后再以**单播**的形式发给DHCP服务器。
      * 3）DHCP服务器收到请求包之后，再向DHCP中继代理返回应答，并由DHCP中继代理将此包转发给DHCP客户端。

      由此，DHCP服务器**即使不在同一链路上**也可以实现统一分配和管理IP地址。

   

   ### 5.6 NAT

   NAT用于在本地网络中使用私有地址，在连接互联网时转而使用IP地址。

   1. 在NAT路由器的内部，有一张自动生成的用来转换地址的表。

   2. 当私有网络内的多台机器同时都要与外部进行通信时，仅仅转换IP地址，人们不必担心全局IP地址是否不够用。

   3. 在使用TCP/UDP的通信当中，只有目标地址、源地址、目标端口、源端口以及协议类型五项内容都一致时才被认为是同一个通信连接。此时所使用的是NAPT。

   4. NAT-PT（NAPT-PT）：将IPv6的首部转换为IPv4首部的技术，有了这种技术，那些只有IPv6地址的主机也就能够与IPv4地址的其他主机进行通信了。

   5. NAT的潜在问题：

      * 无法从NAT网络外部向内部服务器建立连接；
      * 转换表的生成与转换操作都会产生一定的开销；
      * 通信过程中一旦NAT遇到异常需要启动时，所有的TCP连接都将被重置；
      * 即使备置两台NAT做容灾备份，TCP连接还是会被断开。

   6. 解决NAT的潜在问题与NAT穿越：

      * 第一种方法：改用IPv6;
      * 第二种方法：在NAT内测主机上运行的应用先发送一个虚拟的网络包给NAT外侧。NAT并不知道这个虚拟的包是什么，还是会读取包首部的内容并生成一个转换表，这种现象叫做“NAT穿越”。

   7. 但是：

      * **“NAT穿越与已有的IPv4环境兼容性非常好，即使不迁移到IPv6也能通信自如。市面上已经出现了大量与NAT紧密集合的应用。但是NAT的规范越来越复杂，应用的实现变得更耗时。”**
      * 由此，**IPv4的寿命又被延长，向IPv6的迁移也就放慢了脚步。**迁移到IPv6以后，系统会变得更为简单，因此它有着非常大的优势。如果同时使用IPv4和IPv6，会导致系统变得更为复杂。这对于程序开发、设计和运维人员来说是巨大的麻烦。

      

      

      ### 5.7 IP隧道

      1. IP隧道中可以将那些从网络A发过来的IPv6的包统合为一个数据，再为之追加一个IPv4的首部以后转发给网络C。
      2. 一般情况下，紧接着IP首部的是TCP或UDP的首部。然而，现在的应用中“IP首部的后面还是IP首部”或者“IP首部的后面是IPv6的首部”等情况与日俱增。这种在网络层的首部后面追加网络层首部的通信方法就叫做**“IP隧道”**。
      3. 构造一个既支持IPv4，又支持IPv6的网络是一项及其庞大的工程。骨干网上通常使用IPv4或IPv6进行传输。那些不支持的路由器就采用IP隧道的技术转发数据包。
      4. 由于现在很多路由器上没有多播包的路由控制信息，多播消息也就无法穿越路由器发送消息。那么在这类环境中，如果使用IP隧道，就可以使路由器用单播的形式发包，也就能够向距离较远的链路转发多播消息。

      

      ### 5.8 其他IP相关技术

      ##### 1.IP多播技术

      * 在多播消息中，确认接收端是否存在非常必要。如果没有接收端，发送多播消息将会造成网络流量的浪费。而确认是否有多播消息，要通过MLD实现。它是IGMP的重要功能之一，主要有两大作用：
        * 向路由器表明想要接收多播消息，并通知想接收多播的地址；
        * 向交换集线器通知想要接收多播的地址。
      * 首先，路由器会了解到想要接收多播的主机，并将这个信息告知其他路由器，准备接收多播消息。
      * 然后，支持IGMP（MLD）探听的交换集线器可以过滤多播帧，获知多播发送的地址和端口，从而不会再向毫无关系的端口发送多播帧。

      

      **2.IP任播**

      * IP任播是指为那些提供同一种服务的服务器配置同一个IP地址，并与最近的服务器进行通信的一种方法。它适用于IPv4和IPv6.
      * IP任播的应用当中最为有名的当属DNS根域名服务器。使用IP任播可以让更多的DNS根域名服务器散布到世界各地。
      * IP任播机制虽然听起来非常方便，实际上也有不少限制。例如，它不能保证将第一个包和第二个包发送给同一个主机。

      

      **3.通信质量的控制**

      * IP协议的设计和开发初衷是作为一个“尽力服务”的协议，是一款“没有通信服务质量保证”的协议。
      * 通信线路上的拥塞叫做收敛。当网络发生收敛时，路由器和集线器（交换集线器）的队列溢出，会出现大量的丢包现象。
      * 通信质量包括带宽、延迟、时延波动等内容。路由器在内部的队列（缓存）中可以优先处理这些要求保证通信质量的包，甚至有时不得不丢弃那些没有优先级的包以保证通信质量。
      * 为了控制通信质量，人们提出了RSVP技术，它包括两个内容：一是提供点对点的详细有限控制，另一个是提供相对较粗粒度的优先控制。
      * IntServ是针对特定应用之间的通信进行质量控制的一种机制。这里的“”特定的应用是指源IP地址、目标IP地址、源端口、目标端口以及协议号五项完全内容一致。IntServ所涉及的通信并非一直进行，只是在必要的时候进行。因此IntServ也只有在必要的时候才要求在路由器上进行设置，这也叫“流量控制”。

      

      **4.显式拥塞通知**

      * 作为IP上层协议，TCP虽然也能控制网络拥塞，不过它是通过数据包的实际损坏情况来判断是否发生拥塞。然而这种方法并不能在数据包损坏之前减少数据包的发送量。为了解决这个问题，人们在IP层新增了一种使用显示拥塞通知的机制，即ECN。
      * ECN为解决拥塞通知的功能，将IP首部的TOS字段置换为ECN字段，并在TCP首部的保留位中追加CWR标志和ECE标志。
      * **因此，ECN的机制概括起来就是在发送包的IP首部中记录路由器是否遇到拥塞，并在返回包的TCP首部中通知是否发生过拥塞。**拥塞检查在网络层进行，而拥塞通知则在传输层进行，这两层的互相协助实现了拥塞通知的功能。

      

      **5.Mobile IP**

      * IP地址由“网络地址”和“主机地址”两部分组成。其中“网络地址”表示全网中子网的位置，因此对于不同的地域它的值也会有所不同。
      * 对于智能手机和笔记本电脑等移动设备，这些设备没连接到不同的子网中，都会由DHCP或手动的方式分配到不同的IP地址。对于移动设备，所连接的子网一旦发生变化，则无法通过TCP继续通信。这是因为TCP是面向连接的协议，自始至终都需要发送端和接收端主机的IP地址不发生变化。
      * 在UDP的情况下也无法继续通信，不过鉴于UDP是面向非连接的协议，或许可以在应用层面上进行处理变更IP地址的问题。
      * 由此，Mobile IP便登上了历史的舞台。这种技术在主机所连接的子网IP发生变化时，主机IP地址仍保持不变。
      * **Mobile IP中移动的主机，在移动之前按照以往的模式进行通信。而移动之后则通过外部代理发送转发数据包向归属代理通知自己的地址。**

      

      ## 六、TCP与UDP

      * TCP提供可靠的通信传输。
      * UDP则常被用于让广播和细节控制交给应用的通信传输。
      * 传输协议TCP\UDP通过接收数据中的目标端口号识别目标处理程序。

      ### 6.1 端口号

      数据链路和IP中的地址，分别指MAC地址和IP地址。前者用来识别同一链路中的不同计算机，后者用来识别TCP/IP网络中互连的主机和路由器。**在传输层中**也有类似地址的概率，那就是端口号。**端口号用来识别同一台计算机中进行通信的不同应用程序。**

      * TCP/IP或UDP/IP通信中通常采用5个信息来识别一个通信。他们是**“源IP地址”、“目标IP地址”、“协议号”、“源端口号”、“目标端口号”。**只要其中某一项不同，则被认为是其他通信。
      * 端口号如何确定：标准既定的端口号和时序分配法。第一种也叫静态方法，每个应用程序都有其指定的端口号，每个端口号都有其对应的使用目的。第二种方法也叫动态分配方法，客户端应用程序可以完全不用自己设置端口号，全权交给操作系统分配。

      ### 6.2 TCP

      TCP充分地实现了数据传输时各种控制功能，可以进行丢包时的重发机制，还可以对次序乱掉的分包进行顺序控制。

      **连接**：各种设备、线路，或网络中进行通信的两个应用程序为了相互传递消息而专有的、虚拟的通信线路，也叫做虚拟电路。一旦建立了连接，进行通信的应用程序只使用这个虚拟的通信线路发送和接收数据。当连接建立好以后进行通信时，应用程序只需要通过管道的出入口发送或接收数据，就可以实现与对端的网络通信。

      1. 通过序列号与确认应答提高可靠性

      * TCP通过肯定的确认应答（ACK）实现可靠的数据传输。当发送端将数据发出之后会等待对端的确认应答。如果没有确认应答，说明数据已经成功到达对端。在一定时间内没有等到确认应答，发送端就可以认为数据已经丢失，并进行重发。由此，即使产生了丢包，仍然能够保证数据能够到达对端。
      * 确认应答、重发机制以及重复控制等功能都可以通过序列号实现。序列号是按顺序给发送数据的每一个字节都标上号码的编号。接收端查询接收数据TCP首部中的序列号和数据的长度，将自己下一步应该接收的序号作为确认应答返送出去。

      2. 重发超时如何确定

      * 每次发包时都会计算往返时间及其偏差。将这个往返时间和偏差相加，重发超时的时间就是比这个总和稍微大一点的值。TCP/IP的目的是尽量不要浪费网络流量。
      * 达到一定重发次数之后，如果仍然没有任何确认应答返回，就会判断网络或对端主机发生了异常。

      3. 连接管理

      * UDP是一种面向无连接的通信协议，因此不检查对端是否可以通信，直接将UDP包发送出去。TCP与此相反，他会在数据通信之前，通过TCP首部发送一个SYN包作为连接的请求等待应答。如果对端发来确认应答，则认为可以进行数据通信。通信结束时会进行断开连接的处理。
      * 一个连接的建立与断开，正常过程至少需要来回发送7个包才能完成。

      4. TCP以段为单位发送数据

      * 在建立TCP连接的同时，可以确定发送数据包的单位，可以称其为“最大消息长度（MSS）”。TCP在传送大量数据时，是以MSS的大小将数据进行分割发送。进行重发时，也是以MSS为单位。
      * MSS是在三次握手的时候，在两端主机之间被计算得出。两端主机在发出建立连接的请求时，会在TCP首部中写入MSS选项，告诉对方自己的接口能够适应的MSS大小。然后会在两者之间选择一个较小的值投入使用。

      4. 利用窗口控制提高速度

      * 确认应答不再是以每个分段，而是以更大的单位进行确认时，转发时间将会被大幅度地缩短。也就是说，发送端主机，在发送了一个段以后不必要一直等待确认应答，而是继续发送。这跟每个段接收确认应答以后再发送另一个新段相比，即使往返时间边长也不会影响网络的吞吐量。
      * 窗口大小就是指无需等待确认应答而可以继续发送数据的最大值。在这个窗口内的数据即使受到确认应答也可以被发送出去。不过在整个窗口的确认应答没有到达之前，如果其中部分数据出现丢包，那么发送端仍然要负责重传。
      * 当数据发出后如如期收到确认应答就可以不用再进行重发，此时数据就可以从缓冲区清除。

      5. 窗口控制与窗口重发

      * 窗口在一定程度上较大时，即使有少部分的确认应答丢失也不会进行数据重发。可以通过下一个确认应答进行确认。
      * 接收端在没有收到自己所期望序号的数据时，会对之前收到的数据进行确认应答。发送端则一旦收到某个确认应答后，又连续3次收到同样的确认应答，则认为数据已经丢失，需要进行重发。这种机制比起超时机制可以提供更为快速的重发服务。

      6. 流控制

      * 发送端根据自己的实际情况发送数据。但是，接收端可能收到的是一个毫无关系的数据包又可能会在处理其他问题上花费一些时间。因此在为这个数据包做其他处理时会耗费一些时间，甚至在高负荷的情况下无法接收任何数据。如此一来，如果接收端将本应该接收的数据丢弃的话，就又会出发重发机制，从而导致网络流量的浪费。
      * 为了防止这种现象的发生，TCP提供一种机制可以让发送端根据接收端的实际接收能力控制发送的数据量。这就是所谓的**流控制。**
      * 接收端主机向发送端主机通知自己可以接收数据的大小，于是发送端会发送不超过这个限度的数据。该大小限度就被称作窗口大小。
      * TCP首部中，专门有一个字段用来通知窗口大小。发送端主机会根据接收端主机的指示，对发送数据的量进行控制。
      * 发送端主机会时不时地发送一个窗口探测的数据段。

      7. 拥塞控制

      * TCP为了防止网络堵塞的情况出现，在通信一开始时就会通过一个叫做**慢启动**的算法得出数值，对发送数据量进行控制。
      * 在慢启动的时候，将拥塞窗口的大小设置为1，之后每收到一个确认应答（ACK），拥塞窗口的值就会加1。在发送数据包时，将拥塞窗口的大小与接收端主机通知的窗口大小做比较，取其中的较小值。

      8. 提高网络利用率的规范

      * Nagle算法
      * 延迟确认应答
      * 捎带应答：TCP的确认应答和回执数据通过一个包发送。

      

      

      ### 6.3 其他传输层协议

      1. UDP-Lite:扩展UDP机能的一种传输层协议

      

   



























































